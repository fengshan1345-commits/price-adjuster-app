<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家电报价助手</title>
    
    <!-- PWA支持 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="报价助手">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* ========== 全局样式 ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
            padding-top: 50px; /* 为顶部Tab栏留出空间 */
            padding-bottom: 70px; /* 为底部导航栏留出空间 */
        }
        
        /* ========== 顶部标题栏 ========== */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 15px;
            padding-top: env(safe-area-inset-top); /* iOS刘海屏适配 */
        }
        
        .top-header .page-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .top-header .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .header-icon-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .header-icon-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }
        
        /* ========== 底部导航栏 ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom); /* iOS安全区域 */
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            gap: 4px;
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-item-icon {
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .nav-item-label {
            font-size: 12px;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .nav-item.active .nav-item-icon {
            color: #667eea;
            transform: scale(1.1);
        }
        
        .nav-item.active .nav-item-label {
            color: #667eea;
            font-weight: 600;
        }
        
        .nav-item.active.history .nav-item-icon {
            color: #ff6b35;
        }
        
        .nav-item.active.history .nav-item-label {
            color: #ff6b35;
        }
        
        /* 中间突出按钮样式 */
        .nav-item.center-btn {
            flex: 0 0 auto;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            position: relative;
            bottom: 15px;
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
        }
        
        .nav-item.center-btn .special-icon {
            font-size: 18px;
            color: white;
            font-weight: 600;
        }
        
        .nav-item.center-btn.active {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            transform: scale(1.05);
        }
        
        .tab-bar {
            display: none; /* 隐藏旧的顶部导航 */
        }
        
        /* ========== 内容区域 ========== */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ========== 会员限制样式 ========== */
        .membership-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 8px;
        }
        
        .membership-lock-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #f39c12;
        }
        
        .membership-lock-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .membership-lock-desc {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .membership-upgrade-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }
        
        .membership-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(243, 156, 18, 0.4);
        }
        
        .membership-restricted {
            position: relative;
        }
        
        .membership-restricted .control-input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .membership-restricted .control-label {
            position: relative;
        }
        
        .membership-restricted .control-label::after {
            content: "🔒";
            margin-left: 8px;
            color: #f39c12;
            font-size: 14px;
        }
        
        .membership-badge {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        /* ========== 产品管理列表项移动功能样式 ========== */
        .result-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        .result-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            z-index: 1000;
        }
        
        .result-item.drag-over {
            border-color: #667eea;
            background: #f0f8ff;
        }
        
        /* 插入指示线样式 */
        .insert-indicator {
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            margin: 4px 0;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            position: relative;
            z-index: 999;
        }
        
        .insert-indicator::before {
            content: '';
            position: absolute;
            left: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 8px solid #667eea;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }
        
        .insert-indicator::after {
            content: '';
            position: absolute;
            right: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-right: 8px solid #667eea;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }
        
        .drag-handle {
            cursor: grab;
            padding: 8px;
            margin-right: 8px;
            color: #999;
            font-size: 18px;
            user-select: none;
            transition: color 0.2s;
        }
        
        .drag-handle:hover {
            color: #667eea;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .move-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-left: 8px;
        }
        
        .move-btn {
            width: 32px;
            height: 24px;
            border: none;
            background: #f8f9fa;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .move-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .move-btn:disabled {
            background: #f0f0f0;
            color: #ccc;
            cursor: not-allowed;
        }
        
        .item-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 0;
        }
        
        .item-text {
            flex: 1;
            margin-right: 12px;
            word-break: break-word;
        }
        
        .price-display {
            flex-shrink: 0;
        }

        /* ========== 界面1：产品管理 样式 ========== */
        #productManager .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            margin-top: 20px;
            position: relative;
        }
        
        #productManager h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        #productManager .input-section {
            margin-bottom: 20px;
        }
        
        #productManager textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        #productManager textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        #productManager .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #productManager button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #productManager button:hover {
            background-color: #2980b9;
        }
        
        #productManager button.secondary {
            background-color: #95a5a6;
        }
        
        #productManager button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        #productManager button.danger {
            background-color: #e74c3c;
        }
        
        #productManager button.danger:hover {
            background-color: #c0392b;
        }
        
        #productManager .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }
        
        #productManager .stats-vertical {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }
        
        #productManager .stat-item {
            text-align: center;
        }
        
        #productManager .stat-item-vertical {
            text-align: center;
            flex: 1;
        }
        
        #productManager .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        #productManager .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        #productManager .results-container {
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            -webkit-overflow-scrolling: touch;
        }
        
        #productManager .result-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            position: relative;
            cursor: default;
        }
        
        #productManager .result-item:last-child {
            border-bottom: none;
        }
        
        #productManager .result-item:hover {
            background-color: #f8f9fa;
        }
        
        #productManager .result-item.selected {
            background-color: #e8f4fd;
        }
        
        #productManager .checkbox {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        #productManager .checkbox.hidden {
            display: none;
        }
        
        #productManager .price {
            color: #e74c3c;
            font-weight: bold;
            margin-left: 5px;
        }
        
        #productManager .price-display {
            margin-left: auto;
            margin-right: 10px;
        }
        
        #productManager .blue-price {
            color: #2196F3;
            font-weight: bold;
            background-color: #f0f8ff;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #bbdefb;
        }
        
        /* 深色模式：产品管理的价格标签改为蓝色文字、浅灰色背景、浅蓝色边框 */
        .theme-dark #productManager .blue-price {
            color: #2196F3 !important;  /* 蓝色文字 */
            background-color: #e0e0e0 !important;  /* 浅灰色背景 */
            border-color: #90caf9 !important;  /* 浅蓝色边框 */
        }
        
        #productManager .no-price {
            color: #999;
            font-style: italic;
        }
        
        #productManager .sort-controls {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #productManager select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #productManager .copy-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        #productManager .copy-success.show {
            opacity: 1;
        }
        
        /* ========== 界面2：价格调整 样式 ========== */
        #priceAdjuster .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 4vw;
        }
        
        #priceAdjuster .header { 
            text-align: center; 
            margin-bottom: 6vw; 
        }
        
        #priceAdjuster .title { 
            font-size: 6vw; 
            font-weight: 700; 
            color: #333; 
            margin-bottom: 2vw; 
        }
        
        #priceAdjuster .subtitle { 
            font-size: 4vw; 
            color: #666; 
        }
        
        #priceAdjuster .test-section { 
            background: white; 
            border-radius: 12px; 
            padding: 4vw; 
            margin-bottom: 4vw; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        #priceAdjuster .test-title { 
            font-size: 4.5vw; 
            font-weight: 600; 
            margin-bottom: 3vw; 
            color: #333; 
        }
        
        #priceAdjuster .input-area { 
            margin-bottom: 4vw; 
        }
        
        #priceAdjuster .input-text { 
            width: 100%; 
            min-height: 200px; 
            padding: 3vw; 
            font-size: 4vw; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            resize: vertical; 
        }
        
        #priceAdjuster .input-text:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        
        #priceAdjuster .btn { 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 3vw 6vw; 
            border-radius: 8px; 
            font-size: 4vw; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 2vw; 
        }
        
        #priceAdjuster .btn:hover { 
            background: #5a6fd8; 
        }
        
        #priceAdjuster .btn-success { 
            background: #4caf50; 
        }
        
        #priceAdjuster .result-area { 
            margin-top: 4vw; 
        }
        
        #priceAdjuster .result-item { 
            background: #f9f9f9; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 3vw; 
            margin-bottom: 2vw; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        #priceAdjuster .result-item.has-price { 
            border-color: #4caf50; 
            background: #f0f8f0; 
        }
        
        #priceAdjuster .result-item.no-price { 
            border-color: #ff9800; 
            background: #fff8f0; 
        }
        
        #priceAdjuster .result-content { 
            flex: 1; 
            font-size: 3.5vw; 
            color: #333; 
        }
        
        #priceAdjuster .result-price { 
            font-size: 4.5vw; 
            font-weight: 700; 
            color: #4caf50; 
            margin-left: 2vw; 
        }
        
        #priceAdjuster .result-price.original { 
            color: #666; 
            text-decoration: line-through; 
        }
        
        #priceAdjuster .result-price.new { 
            color: #f44336; 
        }
        
        #priceAdjuster .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 2vw; 
            margin-top: 4vw; 
        }
        
        #priceAdjuster .stat-item { 
            text-align: center; 
            padding: 3vw; 
            background: #f0f0f0; 
            border-radius: 8px; 
        }
        
        #priceAdjuster .stat-number { 
            font-size: 6vw; 
            font-weight: 700; 
        }
        
        #priceAdjuster .stat-label { 
            font-size: 3vw; 
            color: #666; 
            margin-top: 1vw; 
        }
        
        #priceAdjuster .price-controls { 
            background: #e8f5e8; 
            padding: 3vw; 
            border-radius: 8px; 
            margin-bottom: 4vw; 
        }
        
        #priceAdjuster .control-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 2vw; 
        }
        
        #priceAdjuster .control-label { 
            font-size: 3.5vw; 
            margin-right: 2vw; 
            min-width: 120px; 
        }
        
        #priceAdjuster .control-input { 
            flex: 1; 
            padding: 2vw; 
            font-size: 3.5vw; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        
        /* ========== 界面3：符号更换 样式 ========== */
        #symbolChanger .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 4vw;
        }
        
        #symbolChanger .header { 
            text-align: center; 
            margin-bottom: 6vw; 
        }
        
        #symbolChanger .title { 
            font-size: 6vw; 
            font-weight: 700; 
            color: #333; 
            margin-bottom: 2vw; 
        }
        
        #symbolChanger .subtitle { 
            font-size: 4vw; 
            color: #666; 
        }
        
        #symbolChanger .test-section { 
            background: white; 
            border-radius: 12px; 
            padding: 4vw; 
            margin-bottom: 4vw; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        #symbolChanger .test-title { 
            font-size: 4.5vw; 
            font-weight: 600; 
            margin-bottom: 3vw; 
            color: #333; 
        }
        
        #symbolChanger .input-area { 
            margin-bottom: 4vw; 
        }
        
        #symbolChanger .input-text { 
            width: 100%; 
            min-height: 200px; 
            padding: 3vw; 
            font-size: 4vw; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            resize: vertical; 
        }
        
        #symbolChanger .input-text:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        
        #symbolChanger .btn { 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 3vw 6vw; 
            border-radius: 8px; 
            font-size: 4vw; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 2vw; 
        }
        
        #symbolChanger .btn:hover { 
            background: #5a6fd8; 
        }
        
        #symbolChanger .btn-success { 
            background: #4caf50; 
        }
        
        #symbolChanger .result-area { 
            margin-top: 4vw; 
            max-height: 60vh; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        
        #symbolChanger .result-area::-webkit-scrollbar {
            width: 6px;
        }
        
        #symbolChanger .result-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #symbolChanger .result-area::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #symbolChanger .result-area::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        #symbolChanger .result-area {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        #symbolChanger .result-item { 
            background: #f9f9f9; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 3vw; 
            margin-bottom: 2vw; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            cursor: default;
        }
        
        #symbolChanger .result-item.has-price { 
            border-color: #4caf50; 
            background: #f0f8f0; 
        }
        
        #symbolChanger .result-item.no-price { 
            border-color: #ff9800; 
            background: #fff8f0; 
        }
        
        #symbolChanger .result-content { 
            flex: 1; 
            font-size: 3.5vw; 
            color: #333; 
        }
        
        #symbolChanger .result-price { 
            font-size: 4.5vw; 
            font-weight: 700; 
            color: #4caf50; 
            margin-left: 2vw; 
        }
        
        #symbolChanger .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 2vw; 
            margin-top: 4vw; 
        }
        
        #symbolChanger .stat-item { 
            text-align: center; 
            padding: 3vw; 
            background: #f0f0f0; 
            border-radius: 8px; 
        }
        
        #symbolChanger .stat-number { 
            font-size: 6vw; 
            font-weight: 700; 
        }
        
        #symbolChanger .stat-label { 
            font-size: 3vw; 
            color: #666; 
            margin-top: 1vw; 
        }
        
        /* ========== 会员系统样式 ========== */
        #membership .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .membership-status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-info {
            display: flex;
            align-items: center;
        }
        
        .status-icon {
            font-size: 40px;
            margin-right: 15px;
        }
        
        .status-text h3 {
            margin: 0 0 5px 0;
            font-size: 24px;
        }
        
        .status-text p {
            margin: 0;
            opacity: 0.9;
        }
        
        .section-title {
            font-size: 20px;
            color: #333;
            margin: 30px 0 20px 0;
            text-align: center;
        }
        
        .packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .package-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .package-card.popular {
            border-color: #ff6b35;
            transform: scale(1.05);
        }
        
        .popular-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b35;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .package-header h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #333;
        }
        
        .package-price {
            margin-bottom: 20px;
        }
        
        .price-new {
            font-size: 32px;
            font-weight: bold;
            color: #ff6b35;
        }
        
        .price-original {
            font-size: 16px;
            color: #999;
            text-decoration: line-through;
            margin-left: 10px;
        }
        
        .package-features {
            text-align: left;
            margin-bottom: 20px;
        }
        
        .package-features p {
            margin: 8px 0;
            font-size: 14px;
            color: #666;
        }
        
        .btn-package {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .btn-package:hover {
            background: #5a6fd8;
        }
        
        .referral-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .referral-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .referral-code {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .referral-code input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 16px;
        }
        
        .btn-small {
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .referral-desc {
            font-size: 14px;
            color: #666;
            margin: 10px 0 0 0;
        }
        
        .referral-input {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        .referral-code-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .referral-code-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .benefit-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .benefit-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .benefit-item h4 {
            margin: 10px 0;
            color: #333;
        }
        
        .benefit-item p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        
        /* ========== 设置界面样式 ========== */
        #settings .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .user-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .user-avatar {
            font-size: 40px;
            margin-right: 15px;
        }
        
        .user-details h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
        }
        
        .user-details p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .login-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .login-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .settings-sections {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .settings-section .section-title {
            font-size: 18px;
            color: #333;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        /* 深色模式：设置界面标题文字改为浅色 */
        .theme-dark .settings-section .section-title {
            color: #e0e0e0 !important;
        }
        
        .theme-dark .setting-item label {
            color: #e0e0e0 !important;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-item label {
            font-weight: 500;
            color: #333;
        }
        
        .setting-item select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkmark {
            margin-left: 8px;
        }
        
        .about-info {
            text-align: center;
        }
        
        .about-info p {
            margin: 10px 0;
            color: #666;
        }
        
        .contact-links {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn-link {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .btn-link:hover {
            color: #5a6fd8;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        /* ========== 主题和字体样式 ========== */
        .theme-dark {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .theme-dark .tab-bar {
            background-color: #2d2d2d;
            border-bottom-color: #444;
        }
        
        .theme-dark .tab-item {
            color: #e0e0e0;
        }
        
        .theme-dark .tab-item.active {
            color: #667eea;
        }
        
        .theme-dark .container {
            background-color: #1a1a1a;
        }
        
        .theme-dark .settings-section {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        .theme-dark .setting-item {
            border-bottom-color: #444;
        }
        
        .theme-dark .setting-item label {
            color: #e0e0e0;
        }
        
        .theme-dark .setting-item select {
            background-color: #3d3d3d;
            border-color: #555;
            color: #e0e0e0;
        }
        
        .theme-dark .modal-content {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        .theme-dark .modal-header {
            border-bottom-color: #444;
        }
        
        .theme-dark .form-group input {
            background-color: #3d3d3d;
            border-color: #555;
            color: #e0e0e0;
        }
        
        .theme-dark .form-group input:focus {
            border-color: #667eea;
        }
        
        /* 深色模式：解析界面、输入框、容器 */
        .theme-dark #pm_inputText,
        .theme-dark #pa_productInput,
        .theme-dark .input-text {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：所有输入框和文本区域 */
        .theme-dark textarea,
        .theme-dark input[type="text"],
        .theme-dark input[type="number"] {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        .theme-dark #pm_resultsContainer,
        .theme-dark .result-item,
        .theme-dark .test-section,
        .theme-dark .container {
            background-color: #1a1a1a !important;
        }
        
        .theme-dark #pm_resultsContainer .result-item {
            background-color: #2d2d2d !important;
            border-color: #444 !important;
            color: #e0e0e0 !important;
        }
        
        .theme-dark .result-text {
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：筛选栏、历史记录卡片 */
        .theme-dark .history-filter-bar,
        .theme-dark .history-card,
        .theme-dark .settings-section {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        .theme-dark .history-filter-bar select {
            background-color: #3d3d3d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：统计卡片 */
        .theme-dark .stat-item-vertical,
        .theme-dark .stat-item {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        .theme-dark .stat-number {
            color: #667eea !important;
        }
        
        /* 深色模式：按钮 */
        .theme-dark .btn {
            background-color: #3d3d3d !important;
            color: #e0e0e0 !important;
            border-color: #555 !important;
        }
        
        .theme-dark .btn.btn-primary {
            background-color: #667eea !important;
            color: white !important;
        }
        
        .theme-dark .btn.danger {
            background-color: #e74c3c !important;
            color: white !important;
        }
        
        .theme-dark .btn.btn-secondary {
            background-color: #3d3d3d !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：解析结果区域 - 边框变细，文字更亮（统一所有界面） */
        .theme-dark #pa_resultArea .result-item,
        .theme-dark #sc_resultArea .result-item,
        .theme-dark .result-item {
            border: 1px solid #444 !important;  /* 边框变细 */
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        /* 统一所有解析文字的颜色，使用浅色保证可读性 */
        .theme-dark #pa_resultArea .result-text,
        .theme-dark #sc_resultArea .result-text,
        .theme-dark .result-text {
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：解析结果显示区域背景 */
        .theme-dark #pa_resultArea,
        .theme-dark #sc_resultArea {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：解析文本内容 - 排除价格标签，让价格可以显示红色和绿色 */
        .theme-dark #pa_resultArea *:not(.result-price):not(.price-increase):not(.price-decrease):not(.result-price.new),
        .theme-dark #sc_resultArea * {
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：蓝色价格标签里的白色文字调为灰黑 */
        .theme-dark .price-tag,
        .theme-dark .btn[style*="blue"],
        .theme-dark .btn-primary {
            color: #4a4a4a !important;  /* 灰黑色，不再用白色 */
        }
        
        /* 深色模式：所有蓝色按钮的文字都变灰黑 */
        .theme-dark .btn.btn-primary {
            color: #4a4a4a !important;
        }
        
        /* 深色模式：符号更换的所有输入框 */
        .theme-dark #sc_inputText,
        .theme-dark #sc_separatorInput,
        .theme-dark textarea#sc_footerText {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：价格调整的设置面板 - 将浅绿色背景改为灰黑色 */
        .theme-dark .price-controls {
            background-color: #2d2d2d !important;
            border-color: #444 !important;
        }
        
        .theme-dark .price-controls * {
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：下拉菜单和输入框背景 */
        .theme-dark select,
        .theme-dark select.control-input {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        .theme-dark input[type="number"],
        .theme-dark input.control-input {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        /* 浅色模式：涨价红色和降价绿色 - 只改字体颜色，不要背景阴影 */
        .price-increase,
        [class*="price-up"],
        [style*="red"],
        .result-price.new.price-increase {  /* 涨价：只改字体为红色 */
            color: #e74c3c !important;  /* 涨价红色 */
        }
        
        .price-decrease,
        [class*="price-down"],
        [style*="green"],
        .result-price.new.price-decrease {  /* 降价：只改字体为绿色 */
            color: #27ae60 !important;  /* 降价绿色 */
        }
        
        .result-price.original {  /* 原价（删除线） */
            color: #999 !important;
            text-decoration: line-through !important;
        }
        
        /* 深色模式：保持涨价红色和降价绿色 - 只改字体颜色，不要背景阴影 */
        .theme-dark .price-increase,
        .theme-dark [class*="price-up"],
        .theme-dark [style*="red"],
        .theme-dark .result-price.new.price-increase,
        .theme-dark .result-price.new.price-increase * {
            color: #ff6666 !important;  /* 涨价红色（深色模式稍微亮一点） */
        }
        
        .theme-dark .price-decrease,
        .theme-dark [class*="price-down"],
        .theme-dark [style*="green"],
        .theme-dark .result-price.new.price-decrease,
        .theme-dark .result-price.new.price-decrease * {
            color: #66ff66 !important;  /* 降价绿色（深色模式稍微亮一点） */
        }
        
        /* 深色模式：原价删除线 - 使用更暗的灰色 */
        .theme-dark .result-price.original {
            color: #666 !important;  /* 深色模式下更暗的灰色 */
            text-decoration: line-through !important;
            text-decoration-color: #666 !important;  /* 删除线也是灰色 */
        }
        
        /* 确保深色模式下新价格标签的颜色不被覆盖 */
        .theme-dark div.result-price span.result-price.new.price-increase {
            color: #ff6666 !important;
        }
        
        .theme-dark div.result-price span.result-price.new.price-decrease {
            color: #66ff66 !important;
        }
        
        /* 原价删除线样式 */
        del,
        [style*="text-decoration: line-through"] {
            color: #999 !important;
            text-decoration-color: #999 !important;
        }
        
        .theme-dark del,
        .theme-dark [style*="text-decoration: line-through"] {
            color: #888 !important;
            text-decoration-color: #888 !important;
        }
        
        /* 深色模式：符号更换页面的结尾说明框 */
        .theme-dark .test-section textarea {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：确保符号更换的结尾说明输入框及其父容器也是深灰色 */
        .theme-dark #sc_footerText,
        .theme-dark #symbolChanger textarea,
        .theme-dark #symbolChanger .input-area {
            background-color: #2d2d2d !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        
        /* 深色模式：统计卡片边框变细且变暗 */
        .theme-dark .stat-item,
        .theme-dark .stat-item-vertical {
            border: 1px solid #3d3d3d !important;  /* 更暗的边框 */
            background-color: #2d2d2d !important;
        }
        
        /* 深色模式：所有白色大边框变暗 */
        .theme-dark .stats,
        .theme-dark .stats-vertical,
        .theme-dark .test-section {
            background-color: #1a1a1a !important;
            border: 1px solid #3d3d3d !important;
        }
        
        .theme-dark .stats .stat-item,
        .theme-dark .stats-vertical .stat-item-vertical {
            border-color: #3d3d3d !important;
            background-color: #2d2d2d !important;
        }
        
        /* 深色模式：符号更换结尾说明区域的父容器 - 覆盖内联样式 */
        .theme-dark #symbolChanger .input-area[style*="background"] {
            background: #1a1a1a !important;
            border-color: #444 !important;
        }
        
        /* 字体大小样式 */
        .font-small {
            font-size: 14px;
        }
        
        .font-small .tab-item {
            font-size: 14px;
        }
        
        .font-small .container h1 {
            font-size: 24px;
        }
        
        .font-small .btn {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .font-large {
            font-size: 18px;
        }
        
        .font-large .tab-item {
            font-size: 18px;
        }
        
        .font-large .container h1 {
            font-size: 32px;
        }
        
        .font-large .btn {
            font-size: 18px;
            padding: 12px 24px;
        }
        
        /* ========== 字体大小应用到解析内容 ========== */
        /* 小字体：价格调整 */
        .font-small #priceAdjuster .result-content {
            font-size: 14px !important;
        }
        .font-small #priceAdjuster .result-price {
            font-size: 16px !important;
        }
        
        /* 小字体：符号更换 */
        .font-small #symbolChanger .result-content {
            font-size: 14px !important;
        }
        .font-small #symbolChanger .result-price {
            font-size: 16px !important;
        }
        
        /* 大字体：价格调整 */
        .font-large #priceAdjuster .result-content {
            font-size: 18px !important;
        }
        .font-large #priceAdjuster .result-price {
            font-size: 20px !important;
        }
        
        /* 大字体：符号更换 */
        .font-large #symbolChanger .result-content {
            font-size: 18px !important;
        }
        .font-large #symbolChanger .result-price {
            font-size: 20px !important;
        }
        
        /* ========== 超大字体样式 ========== */
        .font-extra-large {
            font-size: 24px;
        }
        
        .font-extra-large .tab-item {
            font-size: 24px;
        }
        
        .font-extra-large .container h1 {
            font-size: 40px;
        }
        
        .font-extra-large .btn {
            font-size: 24px;
            padding: 16px 32px;
        }
        
        /* 超大字体：价格调整 */
        .font-extra-large #priceAdjuster .result-content {
            font-size: 24px !important;
        }
        .font-extra-large #priceAdjuster .result-price {
            font-size: 28px !important;
        }
        
        /* 超大字体：符号更换 */
        .font-extra-large #symbolChanger .result-content {
            font-size: 24px !important;
        }
        .font-extra-large #symbolChanger .result-price {
            font-size: 28px !important;
        }
        
        /* ========== 编辑弹窗字体大小 ========== */
        /* 小字体：产品管理编辑弹窗的textarea */
        .font-small .modal-content textarea {
            font-size: 14px !important;
        }
        
        /* 大字体：产品管理编辑弹窗的textarea */
        .font-large .modal-content textarea {
            font-size: 18px !important;
        }
        
        /* 超大字体：产品管理编辑弹窗的textarea */
        .font-extra-large .modal-content textarea {
            font-size: 24px !important;
        }
        
        /* ========== 深色模式：编辑弹窗样式 ========== */
        .theme-dark .modal-content {
            background-color: #2d2d2d !important;
        }
        
        .theme-dark .modal-content h3,
        .theme-dark .modal-content textarea {
            color: #e0e0e0 !important;
        }
        
        /* 日期分组标题样式 */
        .date-group-header {
            background: #f5f5f5;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .date-group-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }
        
        .theme-dark .date-group-header {
            background: #2d2d2d;
        }
        
        .theme-dark .date-group-header h3 {
            color: #e0e0e0;
        }
        
        /* ========== 历史记录样式 ========== */
        .history-filter-bar {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .history-filter-bar .filter-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .history-filter-bar label {
            font-size: 14px;
            color: #666;
        }
        
        .history-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .history-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .history-card.comparing {
            border: 2px solid #ff6b35;
        }
        
        .history-card.comparing::before {
            content: "✓";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b35;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        /* 视图切换器 */
        .view-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 4px;
        }
        
        .view-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
        }
        
        .view-btn.active {
            background: #2196F3;
            color: white;
        }
        
        /* 来源筛选标签栏 */
        .history-filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #666;
            font-weight: 500;
        }
        
        .filter-tab.active {
            background: #e3f2fd;
            color: #2196F3;
            font-weight: 600;
        }
        
        /* 日历式日期选择器 */
        .calendar-picker {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .calendar-header button {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .calendar-header button:hover {
            background: #f5f5f5;
        }
        
        .current-month {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .calendar-weekdays span {
            text-align: center;
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 4px;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: #f5f5f5;
        }
        
        .calendar-day-number {
            font-size: 14px;
            font-weight: 500;
        }
        
        .calendar-day-count {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
        }
        
        .calendar-day.selected {
            background: #2196F3;
            color: white;
        }
        
        .calendar-day.selected .calendar-day-count {
            color: white;
        }
        
        .calendar-day.has-records {
            background: #f0f8ff;
        }
        
        .calendar-day.has-records.selected {
            background: #2196F3;
        }
        
        /* 宫格视图 */
        .history-list.grid-view {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            box-sizing: border-box;
            width: 100%;
        }
        
        .history-list.grid-view .history-card {
            padding: 15px;
            min-width: 0; /* 防止内容撑破列宽 */
            box-sizing: border-box;
        }

        /* 网格视图下的日期标题：占满整行，不悬浮 */
        .history-list.grid-view ~ .date-group-header,
        .history-list.grid-view .date-group-header {
            position: static;
            top: auto;
            margin: 8px 0;
            grid-column: 1 / -1;
            z-index: 1;
        }

        /* 若日期标题在网格容器内创建，确保横跨两列 */
        .history-list.grid-view .date-group-header {
            grid-column: 1 / -1;
        }
        
        .history-list.grid-view .history-card-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* 列表视图 */
        .history-list.list-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .history-list.list-view .history-card {
            display: flex;
            flex-direction: row;
            padding: 12px;
        }
        
        .history-list.list-view .history-card-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .history-card-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-card-thumbnail:hover {
            border-color: #667eea;
        }
        
        /* 文本预览缩略图样式 */
        .history-card-thumbnail-text {
            width: 100%;
            min-height: 150px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .history-card-thumbnail-text:hover {
            border-color: #667eea;
            background: #f0f8ff;
        }
        
        .preview-line {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
            margin: 3px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .preview-line:first-child {
            font-weight: 500;
            color: #555;
        }
        
        .preview-line:last-child {
            color: #666;
        }
        
        /* 宫格视图中的文本预览 */
        .history-list.grid-view .history-card-thumbnail-text {
            min-height: 150px;
            height: 150px;
        }
        
        /* 列表视图中的文本预览 */
        .history-list.list-view .history-card-thumbnail-text {
            width: 100px;
            min-height: 100px;
            height: 100px;
            padding: 8px;
            font-size: 11px;
        }
        
        .history-list.list-view .preview-line {
            font-size: 11px;
            line-height: 1.4;
            margin: 2px 0;
        }
        
        /* 列表视图中如果只有一行，居中显示 */
        .history-list.list-view .history-card-thumbnail-text:has(.preview-line:only-child) {
            justify-content: center;
        }
        
        .theme-dark .history-card-thumbnail-text {
            background: #2d2d2d;
            border-color: #444;
        }
        
        .theme-dark .history-card-thumbnail-text:hover {
            background: #3a3a3a;
            border-color: #667eea;
        }
        
        .theme-dark .preview-line {
            color: #e0e0e0;
        }
        
        .theme-dark .preview-line:first-child {
            color: #f0f0f0;
        }
        
        .theme-dark .preview-line:last-child {
            color: #b0b0b0;
        }
        
        .history-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .history-card-date {
            font-size: 13px;
            color: #999;
            margin-bottom: 12px;
        }
        
        .history-card-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .history-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .history-card-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }
        
        .compare-floating-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(255, 107, 53, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }
        
        .compare-floating-btn:active {
            transform: scale(0.95);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .empty-desc {
            font-size: 14px;
            color: #999;
        }
        
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-viewer-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            touch-action: none;
        }
        
        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 10001;
        }
        
        .image-viewer-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ========== 响应式设计 ========== */
        @media (max-width: 768px) {
            #productManager .container {
                margin: 10px;
                padding: 15px;
            }
            
            #productManager .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            #productManager .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .packages-grid {
                grid-template-columns: 1fr;
            }
            
            .package-card.popular {
                transform: none;
            }
            
            .membership-status-card {
                flex-direction: column;
                text-align: center;
            }
            
            .status-info {
                margin-bottom: 15px;
            }
        }
    </style>
    
    <!-- 已移除 html2canvas 依赖，保存历史采用纯文本，避免外部加载超时导致延迟 -->
</head>
<body>
    <!-- 顶部标题栏 -->
    <div class="top-header">
        <div class="page-title" id="topPageTitle">价格调整</div>
        <div class="header-actions">
            <button class="header-icon-btn" onclick="openCurrentPageMenu()">⋮</button>
        </div>
    </div>
    
    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="nav-item" data-tab="historyViewer" onclick="switchTab('historyViewer')">
            <div class="nav-item-icon">明细</div>
            <div class="nav-item-label">历史</div>
        </div>
        <div class="nav-item active" data-tab="productManager" onclick="switchTab('productManager')">
            <div class="nav-item-icon">产品</div>
            <div class="nav-item-label">产品管理</div>
        </div>
        <div class="nav-item center-btn" data-tab="priceAdjuster" onclick="switchTab('priceAdjuster')">
            <div class="nav-item-icon special-icon">记账</div>
        </div>
        <div class="nav-item" data-tab="symbolChanger" onclick="switchTab('symbolChanger')">
            <div class="nav-item-icon">符号</div>
            <div class="nav-item-label">符号更换</div>
        </div>
        <div class="nav-item" data-tab="settings" onclick="switchTab('settings')">
            <div class="nav-item-icon">我的</div>
            <div class="nav-item-label">我的</div>
        </div>
    </div>
    
    <!-- 界面1：产品管理 -->
    <div id="productManager" class="tab-content">
        <div class="container">
            <h1>产品列表管理器</h1>
            
            <div class="input-section">
                <textarea id="pm_inputText" placeholder="请在此粘贴包含产品信息的文本..."></textarea>
            </div>
            
            <div class="action-buttons">
                <button id="pm_parseBtn">解析文本</button>
                <button id="pm_batchDeleteBtn" class="danger">批量删除</button>
                <button id="pm_deleteSelectedBtn" class="danger" style="display: none;">删除选中</button>
                <button id="pm_cancelDeleteBtn" class="secondary" style="display: none;">取消</button>
                <button id="pm_copyBtn">复制结果</button>
                <button id="pm_saveHistoryBtn" onclick="HistoryManager.showSaveDialog()" style="background: #ff6b35;">📅 保存历史</button>
            </div>
            
            <div class="sort-controls">
                <label>排序方式：</label>
                <select id="pm_sortSelect">
                    <option value="original">原始顺序</option>
                    <option value="priceAsc">价格升序</option>
                    <option value="priceDesc">价格降序</option>
                    <option value="nameAsc">名称升序</option>
                </select>
            </div>
            
            <div class="stats-vertical">
                <div class="stat-item-vertical">
                    <div class="stat-number" id="pm_totalLines">0</div>
                    <div class="stat-label">总行数</div>
                </div>
                <div class="stat-item-vertical">
                    <div class="stat-number" id="pm_priceLines">0</div>
                    <div class="stat-label">含价格行</div>
                </div>
                <div class="stat-item-vertical">
                    <div class="stat-number" id="pm_textLines">0</div>
                    <div class="stat-label">纯文本行</div>
                </div>
            </div>
            
            <div class="results-container" id="pm_resultsContainer"></div>
        </div>
        
        <div class="copy-success" id="pm_copySuccess">复制成功！</div>
    </div>
    
    <!-- 界面2：价格调整 -->
    <div id="priceAdjuster" class="tab-content active">
        <div class="container">
            <div class="header">
                <h1 class="title">💰 价格调整器</h1>
                <p class="subtitle">智能识别价格并精准调整</p>
            </div>
            
            <div class="test-section">
                <h2 class="test-title">📝 输入产品信息</h2>
                <div class="input-area">
                    <textarea class="input-text" id="pa_productInput" placeholder="请粘贴客户的产品信息..."></textarea>
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="PriceAdjuster.parseProducts()">🔍 解析价格</button>
                    <button class="btn btn-success" onclick="PriceAdjuster.applyPricing()">📈 应用调价</button>
                    <button class="btn" onclick="PriceAdjuster.copyResults()">📋 复制结果</button>
                    <button class="btn" onclick="HistoryManager.showSaveDialog('priceAdjuster')" style="background: #ff6b35;">📅 保存历史</button>
                </div>
            </div>
            
            <div class="test-section">
                <h2 class="test-title">⚙️ 调价设置</h2>
                <div class="price-controls">
                    <div class="control-row">
                        <span class="control-label">调价方式:</span>
                        <select class="control-input" id="pa_pricingType">
                            <option value="percentage">百分比调价</option>
                            <option value="fixed">固定金额调价</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label">调价幅度:</span>
                        <input type="number" class="control-input" id="pa_pricingValue" value="5" placeholder="5">
                        <span style="font-size: 3.5vw; margin-left: 1vw;">%</span>
                    </div>
                    <div class="control-row">
                        <span class="control-label">调价方向:</span>
                        <select class="control-input" id="pa_pricingDirection">
                            <option value="increase">涨价</option>
                            <option value="decrease">降价</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label">价格取整:</span>
                        <select class="control-input" id="pa_priceRounding">
                            <option value="none">不取整</option>
                            <option value="ones" selected>个位取整</option>
                            <option value="tens">十位取整</option>
                            <option value="hundreds">百位取整</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label">调价模式:</span>
                        <select class="control-input" id="pa_pricingMode" onchange="PriceAdjuster.togglePricingMode()">
                            <option value="uniform">统一调价</option>
                            <option value="range" selected>区间调价</option>
                        </select>
                    </div>
                    <!-- 区间调价设置 -->
                    <div id="pa_rangePricingSection" style="display: block; margin-top: 3vw; padding: 3vw; background: #f0f8ff; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 2vw; font-size: 4vw;">价格区间设置:</div>
                        <div class="control-row">
                            <span class="control-label">0-999:</span>
                            <input type="number" class="control-input" id="pa_range0_999" value="5" placeholder="5">
                            <span style="font-size: 3.5vw; margin-left: 1vw;">%</span>
                        </div>
                        <div class="control-row">
                            <span class="control-label">1000-1999:</span>
                            <input type="number" class="control-input" id="pa_range1000_1999" value="5" placeholder="5">
                            <span style="font-size: 3.5vw; margin-left: 1vw;">%</span>
                        </div>
                        <div class="control-row">
                            <span class="control-label">2000-4999:</span>
                            <input type="number" class="control-input" id="pa_range2000_4999" value="5" placeholder="5">
                            <span style="font-size: 3.5vw; margin-left: 1vw;">%</span>
                        </div>
                        <div class="control-row">
                            <span class="control-label">5000-9999:</span>
                            <input type="number" class="control-input" id="pa_range5000_9999" value="5" placeholder="5">
                            <span style="font-size: 3.5vw; margin-left: 1vw;">%</span>
                        </div>
                        <div class="control-row">
                            <span class="control-label">10000+:</span>
                            <input type="number" class="control-input" id="pa_range10000_plus" value="5" placeholder="5">
                            <span style="font-size: 3.5vw; margin-left: 1vw;">%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="test-section">
                <h2 class="test-title">📊 解析结果 <button class="btn" onclick="PriceAdjuster.copyResults()" style="float: right; font-size: 3vw; padding: 1.5vw 3vw; margin: 0;">📋 复制</button></h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="pa_totalLines">0</div>
                        <div class="stat-label">总行数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number success" id="pa_priceLines">0</div>
                        <div class="stat-label">含价格行</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number warning" id="pa_textLines">0</div>
                        <div class="stat-label">纯文本行</div>
                    </div>
                </div>
                <div class="result-area" id="pa_resultArea"></div>
            </div>
        </div>
    </div>
    
    <!-- 界面3：符号更换 -->
    <div id="symbolChanger" class="tab-content">
        <div class="container">
            <div class="header">
                <h1 class="title">🔄 符号更换器</h1>
                <p class="subtitle">批量更换价格前的符号</p>
            </div>
            
            <div class="test-section">
                <h2 class="test-title">📝 输入产品信息</h2>
                <div class="input-area">
                    <textarea class="input-text" id="sc_productInput" placeholder="请粘贴客户的产品信息..."></textarea>
                </div>
                
                <div class="input-area" style="margin-top: 3vw;">
                    <label style="font-size: 3.5vw; color: #666; margin-bottom: 1vw; display: block;">💰 价格前替换符号：</label>
                    <input type="text" id="sc_priceSeparator" placeholder="输入替换符号（如💰、【发】等）" value="" style="width: 100%; padding: 3vw; font-size: 4vw; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <p style="font-size: 3vw; color: #999; margin-top: 1vw;">提示：留空表示不替换，支持表情符号</p>
                </div>
                
                <!-- 结尾说明设置 -->
                <div class="input-area" style="margin-top: 3vw; padding: 3vw; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="display: flex; align-items: center; margin-bottom: 2vw;">
                        <input type="checkbox" id="sc_enableFooter" style="margin-right: 2vw; transform: scale(1.2);">
                        <label for="sc_enableFooter" style="font-size: 3.5vw; color: #333; font-weight: 600;">自动添加结尾说明</label>
                    </div>
                    <textarea id="sc_footerText" placeholder="输入结尾说明内容..." style="width: 100%; padding: 3vw; font-size: 3.5vw; border: 2px solid #e0e0e0; border-radius: 8px; min-height: 80px; resize: vertical;">平台现查，价格可能会有波动，感谢理解！部分产品私聊询价下单，期待合作[握手]</textarea>
                    <p style="font-size: 3vw; color: #999; margin-top: 1vw;">提示：勾选后，此内容将自动添加到文章末尾。</p>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn" onclick="SymbolChanger.parseProducts()">🔍 解析价格</button>
                    <button class="btn btn-primary" onclick="SymbolChanger.applyPriceSeparator()" style="margin-top: 2vw;">✨ 应用更换</button>
                    <button class="btn btn-success" onclick="SymbolChanger.copyResults()" style="margin-top: 2vw;">📋 复制结果</button>
                    <button class="btn" onclick="HistoryManager.showSaveDialog('symbolChanger')" style="background: #ff6b35; margin-top: 2vw;">📅 保存历史</button>
                </div>
            </div>
            
            <div class="test-section">
                <h2 class="test-title">📊 解析结果 <button class="btn" onclick="SymbolChanger.copyResults()" style="float: right; font-size: 3vw; padding: 1.5vw 3vw; margin: 0;">📋 复制</button></h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="sc_totalLines">0</div>
                        <div class="stat-label">总行数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number success" id="sc_priceLines">0</div>
                        <div class="stat-label">含价格行</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number warning" id="sc_textLines">0</div>
                        <div class="stat-label">纯文本行</div>
                    </div>
                </div>
                <div class="result-area" id="sc_resultArea"></div>
            </div>
        </div>
    </div>
    
    <!-- 界面4：会员中心 -->
    <div id="membership" class="tab-content">
        <div class="container">
            <div class="header">
                <h1 class="title">👑 会员中心</h1>
                <p class="subtitle">解锁更多功能，享受专业服务</p>
            </div>
            
            <!-- 会员状态卡片 -->
            <div class="membership-status-card" id="membershipStatusCard">
                <div class="status-info">
                    <div class="status-icon">👑</div>
                    <div class="status-text">
                        <h3 id="membershipStatus">免费用户</h3>
                        <p id="membershipExpiry">立即开通会员，享受更多功能</p>
                    </div>
                </div>
                <div class="status-actions">
                    <button class="btn btn-primary" onclick="Membership.showPurchaseModal()">开通会员</button>
                </div>
            </div>
            
            <!-- 会员套餐选择 -->
            <div class="membership-packages" id="membershipPackages" style="display: none;">
                <h2 class="section-title">选择会员套餐</h2>
                <div class="packages-grid">
                    <!-- 月度套餐 -->
                    <div class="package-card" data-package="monthly">
                        <div class="package-header">
                            <h3>月度会员</h3>
                            <div class="package-price">
                                <span class="price-new">¥19</span>
                                <span class="price-original">¥33</span>
                            </div>
                        </div>
                        <div class="package-features">
                            <p>✅ 30天会员权益</p>
                            <p>✅ 无限制使用所有功能</p>
                            <p>✅ 优先客服支持</p>
                        </div>
                        <button class="btn btn-package" onclick="Membership.selectPackage('monthly')">立即购买</button>
                    </div>
                    
                    <!-- 半年套餐 -->
                    <div class="package-card popular" data-package="halfyear">
                        <div class="popular-badge">最划算</div>
                        <div class="package-header">
                            <h3>半年会员</h3>
                            <div class="package-price">
                                <span class="price-new">¥99</span>
                                <span class="price-original">¥198</span>
                            </div>
                        </div>
                        <div class="package-features">
                            <p>✅ 120天会员权益（买3送3）</p>
                            <p>✅ 无限制使用所有功能</p>
                            <p>✅ 优先客服支持</p>
                            <p>✅ 专属会员标识</p>
                        </div>
                        <button class="btn btn-package" onclick="Membership.selectPackage('halfyear')">立即购买</button>
                    </div>
                    
                    <!-- 年度套餐 -->
                    <div class="package-card" data-package="yearly">
                        <div class="package-header">
                            <h3>年度会员</h3>
                            <div class="package-price">
                                <span class="price-new">¥188</span>
                                <span class="price-original">¥396</span>
                            </div>
                        </div>
                        <div class="package-features">
                            <p>✅ 360天会员权益（买6送6）</p>
                            <p>✅ 无限制使用所有功能</p>
                            <p>✅ 优先客服支持</p>
                            <p>✅ 专属会员标识</p>
                            <p>✅ 推荐奖励特权</p>
                        </div>
                        <button class="btn btn-package" onclick="Membership.selectPackage('yearly')">立即购买</button>
                    </div>
                </div>
            </div>
            
            <!-- 推荐系统 -->
            <div class="referral-section">
                <h2 class="section-title">推荐好友</h2>
                <div class="referral-card">
                    <div class="referral-info">
                        <h3>我的推荐码</h3>
                        <div class="referral-code">
                            <input type="text" id="myReferralCode" readonly>
                            <button class="btn btn-small" onclick="Membership.copyReferralCode()">复制</button>
                        </div>
                        <p class="referral-desc">好友使用您的推荐码注册，双方都能获得会员天数奖励！</p>
                    </div>
                </div>
                
                <div class="referral-input">
                    <h3>输入推荐码</h3>
                    <div class="referral-code-input">
                        <input type="text" id="referralCodeInput" placeholder="请输入推荐码">
                        <button class="btn btn-primary" onclick="Membership.applyReferralCode()">使用推荐码</button>
                    </div>
                </div>
            </div>
            
            <!-- 会员特权说明 -->
            <div class="member-benefits">
                <h2 class="section-title">会员特权</h2>
                <div class="benefits-grid">
                    <div class="benefit-item">
                        <div class="benefit-icon">🚀</div>
                        <h4>无限制使用</h4>
                        <p>解除所有功能限制，畅享完整体验</p>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">⚡</div>
                        <h4>优先处理</h4>
                        <p>享受更快的处理速度和优先客服</p>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">🎁</div>
                        <h4>推荐奖励</h4>
                        <p>推荐好友获得额外会员天数奖励</p>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">💎</div>
                        <h4>专属标识</h4>
                        <p>显示专属会员标识，彰显身份</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 界面5：历史记录 -->
    <div id="historyViewer" class="tab-content">
        <div class="container">
            <div class="header" style="position: relative;">
                <h1 class="title">📅 历史记录</h1>
                <p class="subtitle">查看和对比历史报价</p>
                
                <!-- 视图切换器 -->
                <div class="view-switcher">
                    <button class="view-btn active" data-view="grid" onclick="HistoryManager.switchView('grid')">
                        <span class="icon">⊞</span>
                    </button>
                    <button class="view-btn" data-view="list" onclick="HistoryManager.switchView('list')">
                        <span class="icon">☰</span>
                    </button>
                </div>
            </div>
            
            <!-- 来源筛选标签栏 -->
            <div class="history-filter-tabs">
                <button class="filter-tab active" data-filter="all" onclick="HistoryManager.filterBySource('all')">
                    ⭐ 全部
                </button>
                <button class="filter-tab" data-filter="productManager" onclick="HistoryManager.filterBySource('productManager')">
                    📦 产品管理
                </button>
                <button class="filter-tab" data-filter="priceAdjuster" onclick="HistoryManager.filterBySource('priceAdjuster')">
                    💰 价格调整
                </button>
                <button class="filter-tab" data-filter="symbolChanger" onclick="HistoryManager.filterBySource('symbolChanger')">
                    🔄 符号更换
                </button>
            </div>
            
            <!-- 日历式日期选择器 -->
            <div class="calendar-picker">
                <div class="calendar-header">
                    <button class="prev-month" onclick="HistoryManager.changeMonth(-1)">‹</button>
                    <span class="current-month" id="calendarCurrentMonth">2025 / 10</span>
                    <button class="next-month" onclick="HistoryManager.changeMonth(1)">›</button>
                </div>
                <div class="calendar-weekdays">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                </div>
                <div class="calendar-days" id="calendarDays">
                    <!-- 动态生成日期格子 -->
                </div>
            </div>
            
            <!-- 筛选工具栏 -->
            <div class="history-filter-bar" style="display: none;">
                <div class="filter-row">
                    <label>年份：</label>
                    <select id="historyYearSelect">
                        <option value="all">全部</option>
                    </select>
                </div>
                <div class="filter-row">
                    <label>月份：</label>
                    <select id="historyMonthSelect">
                        <option value="all">全部</option>
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
                <div class="filter-row">
                    <button class="btn btn-secondary" onclick="HistoryManager.filterRecords()">筛选</button>
                    <button class="btn" onclick="HistoryManager.clearFilter()">重置</button>
                </div>
            </div>
            
            <!-- 操作工具栏 -->
            <div class="history-actions">
                <button class="btn btn-primary" onclick="HistoryManager.enterCompareMode()">选择对比</button>
                <button class="btn btn-danger" onclick="HistoryManager.deleteAll()" style="display: none;">清空历史</button>
            </div>
            
            <!-- 历史记录列表 -->
            <div class="history-list grid-view" id="historyListContainer">
                <!-- 空状态提示 -->
                <div class="empty-state" id="historyEmptyState">
                    <div class="empty-icon">📅</div>
                    <div class="empty-title">暂无历史记录</div>
                    <div class="empty-desc">在产品管理界面保存记录后，将显示在这里</div>
                </div>
            </div>
            
            <!-- 对比模式浮动按钮 -->
            <button class="compare-floating-btn" id="compareFloatingBtn" style="display: none;" onclick="HistoryManager.startCompare()">
                开始对比（<span id="compareCount">0</span>）
            </button>
        </div>
    </div>
    
    <!-- 界面6：我的（整合会员、登录、帮助、设置） -->
    <div id="settings" class="tab-content">
        <div class="container">
            <div class="header">
                <h1 class="title">👤 我的</h1>
                <p class="subtitle">个人中心</p>
            </div>
            
            <!-- 用户信息卡片 -->
            <div class="user-info-card" id="userInfoCard">
                <div class="user-avatar">👤</div>
                <div class="user-details">
                    <h3 id="userName">未登录</h3>
                    <p id="userStatus">点击登录享受更多功能</p>
                </div>
                <div class="login-buttons" id="loginButtons">
                    <button class="btn btn-primary" onclick="Settings.handlePhoneLogin()" id="phoneLoginBtn">📱 登录</button>
                </div>
            </div>
            
            <!-- 快捷功能区 -->
            <div class="settings-sections">
                <!-- 会员中心 -->
                <div class="settings-section">
                    <h3 class="section-title">👑 会员与增值</h3>
                    <div class="setting-item">
                        <span>会员中心</span>
                        <button class="btn btn-small" onclick="switchTab('membership')">前往</button>
                    </div>
                    <div class="setting-item">
                        <span>会员状态</span>
                        <span id="membershipStatusInSettings" style="color: #999;">免费用户</span>
                    </div>
                </div>
                
                <!-- 帮助与支持 -->
                <div class="settings-section">
                    <h3 class="section-title">📚 帮助与支持</h3>
                    <div class="setting-item">
                        <span>使用帮助</span>
                        <button class="btn btn-secondary" onclick="Settings.showHelp()">查看</button>
                    </div>
                    <div class="setting-item">
                        <span>意见反馈</span>
                        <button class="btn btn-secondary" onclick="Settings.showFeedback()">提交</button>
                    </div>
                </div>
                
                <!-- 外观设置 -->
                <div class="settings-section">
                    <h3 class="section-title">🎨 外观设置</h3>
                    <div class="setting-item">
                        <label>主题模式</label>
                        <select id="themeSelect" onchange="Settings.changeTheme()">
                            <option value="light">浅色模式</option>
                            <option value="dark">深色模式</option>
                            <option value="auto">跟随系统</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>字体大小</label>
                        <select id="fontSizeSelect" onchange="Settings.changeFontSize()">
                            <option value="small">小</option>
                            <option value="medium" selected>中</option>
                            <option value="large">大</option>
                            <option value="extra-large">超大</option>
                        </select>
                    </div>
                </div>
                
                <!-- 功能设置 -->
                <div class="settings-section">
                    <h3 class="section-title">🔧 功能设置</h3>
                    <div class="setting-item">
                        <label>自动保存</label>
                        <label class="switch">
                            <input type="checkbox" id="autoSave" checked onchange="Settings.toggleAutoSave()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>价格识别提示</label>
                        <label class="switch">
                            <input type="checkbox" id="priceHint" checked onchange="Settings.togglePriceHint()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>震动反馈</label>
                        <label class="switch">
                            <input type="checkbox" id="vibration" onchange="Settings.toggleVibration()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 数据管理 -->
                <div class="settings-section">
                    <h3 class="section-title">📊 数据管理</h3>
                    <div class="setting-item">
                        <label>导出数据</label>
                        <button class="btn btn-secondary" onclick="Settings.exportData()">导出</button>
                    </div>
                    <div class="setting-item">
                        <label>导入数据</label>
                        <input type="file" id="importFile" accept=".json" onchange="Settings.importData()" style="display: none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">导入</button>
                    </div>
                    <div class="setting-item">
                        <label>清除数据</label>
                        <button class="btn btn-danger" onclick="Settings.clearData()">清除</button>
                    </div>
                </div>
                
                <!-- 关于我们 -->
                <div class="settings-section">
                    <h3 class="section-title">ℹ️ 关于我们</h3>
                    <div class="about-info">
                        <p><strong>家电报价助手</strong></p>
                        <p>版本：1.0.0</p>
                        <p>专为家电行业打造的智能报价工具</p>
                        <div class="contact-links">
                            <button class="btn btn-link" onclick="Settings.showFeedback()">意见反馈</button>
                            <button class="btn btn-link" onclick="Settings.showHelp()">使用帮助</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 登录模态框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>用户登录</h2>
                <span class="close" onclick="Settings.closeLoginModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">用户名</label>
                        <input type="text" id="username" placeholder="请输入用户名" required>
                    </div>
                    <div class="form-group">
                        <label for="password">密码</label>
                        <input type="password" id="password" placeholder="请输入密码" required>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkmark"></span>
                            记住我
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">登录</button>
                        <button type="button" class="btn btn-secondary" onclick="Settings.showRegisterModal()">注册</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 注册模态框 -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>用户注册</h2>
                <span class="close" onclick="Settings.closeRegisterModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regUsername">用户名</label>
                        <input type="text" id="regUsername" placeholder="请输入用户名" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">密码</label>
                        <input type="password" id="regPassword" placeholder="请输入密码" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认密码</label>
                        <input type="password" id="confirmPassword" placeholder="请再次输入密码" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">邮箱（可选）</label>
                        <input type="email" id="regEmail" placeholder="请输入邮箱">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">注册</button>
                        <button type="button" class="btn btn-secondary" onclick="Settings.showLoginModal()">返回登录</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 阿里云号码认证 H5 SDK - 使用官方CDN -->
    <script type="text/javascript" charset="utf-8" src="https://g.alicdn.com/dingding/h5-phone-number-verification/1.0.0/numberAuth-web-sdk.js" 
            onload="console.log('阿里云SDK加载成功，PhoneNumberServer:', typeof PhoneNumberServer)" 
            onerror="console.log('阿里云SDK加载失败，尝试备用链接')"></script>
    
    <!-- 备用SDK链接 - 使用不同的CDN -->
    <script type="text/javascript" charset="utf-8" src="https://g.alicdn.com/dingding/h5-phone-number-verification/latest/numberAuth-web-sdk.js" 
            onload="console.log('备用SDK加载成功，PhoneNumberServer:', typeof PhoneNumberServer)" 
            onerror="console.log('备用SDK也加载失败，使用模拟模式')"></script>
    
    <!-- 如果SDK加载失败，提供模拟实现 -->
    <script>
        // 如果SDK加载失败，提供模拟实现
        if (typeof PhoneNumberServer === 'undefined') {
            console.log('SDK加载失败，创建模拟PhoneNumberServer');
            window.PhoneNumberServer = function() {
                this.checkLoginAvailable = function(options) {
                    console.log('模拟checkLoginAvailable被调用');
                    if (options.success) {
                        options.success({ code: 600000, message: '模拟鉴权成功' });
                    }
                };
                this.getLoginToken = function(options) {
                    console.log('模拟getLoginToken被调用');
                    if (options.success) {
                        options.success({ spToken: 'mock_sp_token_' + Date.now() });
                    }
                };
            };
            console.log('模拟PhoneNumberServer已创建');
        }
    </script>
    
    <script>
        // ========== 阿里云号码认证配置 ==========
        const ALIYUN_CONFIG = {
            sceneCode: 'FC220000012450005', // 您的方案 Code
            // 生产模式：启用真实的阿里云号码认证
            isDevelopment: false
        };
        
        // ========== 页面加载完成后的SDK检查 ==========
        window.addEventListener('load', function() {
            console.log('页面加载完成，检查SDK状态...');
            console.log('PhoneNumberServer:', typeof PhoneNumberServer);
            console.log('window.PhoneNumberServer:', typeof window.PhoneNumberServer);
            
            // 延迟检查，确保SDK有时间加载
            setTimeout(function() {
                console.log('延迟检查SDK状态...');
                console.log('PhoneNumberServer:', typeof PhoneNumberServer);
                console.log('window.PhoneNumberServer:', typeof window.PhoneNumberServer);
            }, 2000);
        });
        
        // ========== 会员权限检查系统 ==========
        function checkMembershipStatus() {
            // 从会员系统获取状态
            return Membership && Membership.isMember ? Membership.isMember() : false;
        }
        
        function updateMembershipBadge() {
            const badge = document.getElementById('membershipStatusBadge');
            if (checkMembershipStatus()) {
                badge.style.display = 'inline-block';
                badge.textContent = '👑 会员';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function showMembershipUpgradePrompt(featureName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <div style="font-size: 48px; margin-bottom: 16px;">🔒</div>
                    <h3 style="margin: 0 0 8px 0; color: #2c3e50;">${featureName}</h3>
                    <p style="margin: 0 0 24px 0; color: #7f8c8d;">此功能为会员专享，立即开通享受更多特权！</p>
                    <button class="membership-upgrade-btn" onclick="Membership.showPurchaseModal(); this.closest('.modal')?.remove();">
                        立即开通会员
                    </button>
                    <button onclick="this.closest('.modal')?.remove();" style="
                        background: #95a5a6;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        margin-left: 12px;
                        cursor: pointer;
                    ">取消</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function createMembershipOverlay(featureName) {
            const overlay = document.createElement('div');
            overlay.className = 'membership-overlay';
            overlay.innerHTML = `
                <div class="membership-lock-icon">🔒</div>
                <div class="membership-lock-title">${featureName}</div>
                <div class="membership-lock-desc">此功能为会员专享<br>立即开通享受更多特权！</div>
                <button class="membership-upgrade-btn" onclick="Membership.showPurchaseModal()">
                    立即开通会员
                </button>
            `;
            return overlay;
        }
        
        // ========== 各模块会员限制初始化函数 ==========
        function initProductManagerRestrictions() {
            const container = document.getElementById('productManager').querySelector('.container');
            if (!checkMembershipStatus()) {
                // 如果已经有遮罩层，先移除
                const existingOverlay = container.querySelector('.membership-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                
                // 添加遮罩层
                const overlay = createMembershipOverlay('产品管理');
                container.appendChild(overlay);
            } else {
                // 会员用户，移除遮罩层
                const existingOverlay = container.querySelector('.membership-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
            }
        }
        
        function initPriceAdjusterRestrictions() {
            const container = document.getElementById('priceAdjuster').querySelector('.container');
            
            // 价格取整选项限制
            const priceRoundingSelect = document.getElementById('pa_priceRounding');
            const priceRoundingLabel = priceRoundingSelect.previousElementSibling;
            
            // 调价模式选项限制
            const pricingModeSelect = document.getElementById('pa_pricingMode');
            const pricingModeLabel = pricingModeSelect.previousElementSibling;
            
            if (!checkMembershipStatus()) {
                // 非会员：禁用高级选项
                priceRoundingSelect.disabled = true;
                priceRoundingLabel.classList.add('membership-restricted');
                
                // 隐藏区间调价选项
                const rangeOption = pricingModeSelect.querySelector('option[value="range"]');
                if (rangeOption) {
                    rangeOption.style.display = 'none';
                }
                pricingModeSelect.value = 'uniform';
                pricingModeSelect.disabled = true;
                pricingModeLabel.classList.add('membership-restricted');
                
                // 添加点击事件显示升级提示
                priceRoundingSelect.addEventListener('click', function() {
                    if (this.disabled) {
                        showMembershipUpgradePrompt('价格取整功能');
                    }
                });
                
                pricingModeSelect.addEventListener('click', function() {
                    if (this.disabled) {
                        showMembershipUpgradePrompt('区间调价功能');
                    }
                });
            } else {
                // 会员：启用所有选项
                priceRoundingSelect.disabled = false;
                priceRoundingLabel.classList.remove('membership-restricted');
                
                const rangeOption = pricingModeSelect.querySelector('option[value="range"]');
                if (rangeOption) {
                    rangeOption.style.display = 'block';
                }
                pricingModeSelect.disabled = false;
                pricingModeLabel.classList.remove('membership-restricted');
            }
        }
        
        function initSymbolChangerRestrictions() {
            const container = document.getElementById('symbolChanger').querySelector('.container');
            if (!checkMembershipStatus()) {
                // 如果已经有遮罩层，先移除
                const existingOverlay = container.querySelector('.membership-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                
                // 添加遮罩层
                const overlay = createMembershipOverlay('符号更换');
                container.appendChild(overlay);
            } else {
                // 会员用户，移除遮罩层
                const existingOverlay = container.querySelector('.membership-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
            }
        }

        // ========== Tab切换逻辑 ==========
        document.addEventListener('DOMContentLoaded', function() {
            const tabItems = document.querySelectorAll('.tab-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // 检查会员权限
                    if (targetTab === 'productManager' || targetTab === 'symbolChanger') {
                        if (!checkMembershipStatus()) {
                            showMembershipUpgradePrompt(targetTab === 'productManager' ? '产品管理' : '符号更换');
                            return;
                        }
                    }
                    
                    // 移除所有active类
                    tabItems.forEach(tab => tab.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 添加active类到当前项
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                    
                    // 初始化对应模块的会员限制
                    if (targetTab === 'productManager') {
                        initProductManagerRestrictions();
                    } else if (targetTab === 'priceAdjuster') {
                        initPriceAdjusterRestrictions();
                    } else if (targetTab === 'symbolChanger') {
                        initSymbolChangerRestrictions();
                    }
                });
            });
            
            // 初始化各个界面
            ProductManager.init();
            PriceAdjuster.init();
            SymbolChanger.init();
            
            // 初始化价格调整的会员限制（因为默认显示价格调整界面）
            initPriceAdjusterRestrictions();
            
            // 更新会员状态徽章
            updateMembershipBadge();
        });
        
        // ========== 界面1：产品管理 JavaScript ==========
        const ProductManager = (function() {
            let parsedItems = [];
            let batchDeleteMode = false;
            
            function init() {
                const parseBtn = document.getElementById('pm_parseBtn');
                const batchDeleteBtn = document.getElementById('pm_batchDeleteBtn');
                const deleteSelectedBtn = document.getElementById('pm_deleteSelectedBtn');
                const cancelDeleteBtn = document.getElementById('pm_cancelDeleteBtn');
                const copyBtn = document.getElementById('pm_copyBtn');
                const sortSelect = document.getElementById('pm_sortSelect');
                const inputText = document.getElementById('pm_inputText');
                
                parseBtn.addEventListener('click', parseText);
                batchDeleteBtn.addEventListener('click', enterBatchDeleteMode);
                deleteSelectedBtn.addEventListener('click', deleteSelectedItems);
                cancelDeleteBtn.addEventListener('click', exitBatchDeleteMode);
                copyBtn.addEventListener('click', copyResults);
                sortSelect.addEventListener('change', sortAndDisplayItems);
                inputText.addEventListener('keydown', handleEnterKey);
            }
            
            function handleEnterKey(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    parseText();
                }
            }
            
            function parseText() {
                const text = document.getElementById('pm_inputText').value.trim();
                if (!text) return;
                
                const lines = text.split('\n');
                parsedItems = [];
                
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;
                    
                    const result = parseProducts(trimmedLine);
                    
                    if (result && result.hasPrice && result.prices && result.prices.length > 0) {
                        // 有价格的产品
                        parsedItems.push({
                            id: index,
                            originalLine: trimmedLine,
                            name: result.content || '未知产品',
                            price: result.prices[0].price,
                            hasPrice: true,
                            selected: false
                        });
                    } else {
                        // 无价格的行
                        parsedItems.push({
                            id: index,
                            originalLine: trimmedLine,
                            name: trimmedLine,
                            price: null,
                            hasPrice: false,
                            selected: false
                        });
                    }
                });
                
                updateStats();
                sortAndDisplayItems();
            }
            
            function parseProducts(line) {
                // 使用价格调整界面的高精度算法
                return purePriceParse(line);
            }
            
            // 纯价格解析 - 高准确率版本（从价格调整界面复制）
            function purePriceParse(line) {
                // 跳过明显的非产品行
                if (isNonProductLine(line)) {
                    return {
                        original: line,
                        hasPrice: false,
                        prices: [],
                        content: line,
                        type: 'text',
                        debug: { method: 'non-product' }
                    };
                }
                
                // 寻找所有价格
                let allPrices = [];
                
                // 第一步：寻找明确的价格标识
                let explicitPrices = findExplicitPrices(line);
                allPrices = allPrices.concat(explicitPrices);
                
                // 第二步：寻找上下文价格
                let contextPrices = findContextPrices(line);
                allPrices = allPrices.concat(contextPrices);
                
                // 去重并排序
                allPrices = removeDuplicatePrices(allPrices);
                
                // 只选择最靠后的一个价格
                if (allPrices.length > 0) {
                    // 按位置排序，选择最靠后的
                    allPrices.sort((a, b) => b.position - a.position);
                    const singlePrice = [allPrices[0]]; // 只取最靠后的一个
                    
                    return {
                        original: line,
                        hasPrice: true,
                        prices: singlePrice,
                        content: line,
                        type: 'product',
                        debug: { method: 'single-price', count: 1 }
                    };
                }
                
                return {
                    original: line,
                    hasPrice: false,
                    prices: [],
                    content: line,
                    type: 'text',
                    debug: { method: 'no-price' }
                };
            }
            
            // 非产品行过滤函数（从价格调整界面复制）
            function isNonProductLine(line) {
                const nonProductPatterns = [
                    /^————+$/, 
                    /^\[红包\].*\[红包\]$/,
                    /^[\s\-_=]+$/,
                    /平台现查|价格可能会波动/,
                    /全国包邮|深圳|河源|惠州/,
                    /现货秒发|其他机型询价/,
                    /更多其他品牌型号/,
                    /备注：|以上几款|以实际开单为准/,
                    /^\.+$/,
                    /^[一二三四五六七八九十]+、/,
                    /我司产品可开票/
                ];
                return nonProductPatterns.some(pattern => pattern.test(line));
            }
            
            function findExplicitPrices(line) {
                let prices = [];
                
                // 货币符号价格
                let currencyPattern = /[¥$]\s*(\d+(?:\.\d+)?)/g;
                let match;
                while ((match = currencyPattern.exec(line)) !== null) {
                    const price = parseFloat(match[1]);
                    if (price >= 199 && price <= 99999) {
                        prices.push({ price: price, method: 'currency', position: match.index });
                    }
                }
                
                // 带单位的价格
                let unitPattern = /(\d+(?:\.\d+)?)\s*(元|块|台|多|起|限|特)/g;
                while ((match = unitPattern.exec(line)) !== null) {
                    const price = parseFloat(match[1]);
                    if (price >= 199 && price <= 99999) {
                        prices.push({ price: price, method: 'unit', position: match.index });
                    }
                }
                
                // 带表情符号的价格识别已移除，避免6XXX价格识别错误
                
                return prices;
            }
            
            function findContextPrices(line) {
                let prices = [];
                
                // 从后往前寻找价格 - 优先识别行末的价格
                const numbers = line.match(/\d{3,}/g);
                if (!numbers) return prices;
                
                // 修复位置计算：使用正则的match.index精确定位，避免lastIndexOf歧义
                const numbersWithPosition = [];
                let regex = /\d{3,}/g;
                let match;
                while ((match = regex.exec(line)) !== null) {
                    numbersWithPosition.push({
                        num: match[0],
                        value: parseInt(match[0]),
                        position: match.index
                    });
                }
                
                // 按位置从后往前排序
                numbersWithPosition.sort((a, b) => b.position - a.position);
                
                for (let i = 0; i < numbersWithPosition.length; i++) {
                    const numInfo = numbersWithPosition[i];
                    const num = numInfo.value;
                    
                    if (num >= 199 && num <= 99999) { // 限制在199-99999之间
                        // 检查上下文（位置因素已在getPriceContext中考虑）
                        const context = getPriceContext(line, numInfo.num, numInfo.position);
                        
                        // 使用getPriceContext返回的置信度
                        let confidence = context.confidence;
                        
                        // 检查是否在斜杠后（通常是价格）
                        const beforeNum = line.substring(Math.max(0, numInfo.position - 5), numInfo.position);
                        if (beforeNum.includes('/')) {
                            confidence += 0.2; // 斜杠后通常是价格
                        }
                        
                        // 检查是否在括号前（通常是价格）
                        const afterNum = line.substring(numInfo.position + numInfo.num.length, Math.min(line.length, numInfo.position + numInfo.num.length + 5));
                        if (afterNum.includes('(') || afterNum.includes(')')) {
                            confidence += 0.1; // 括号前可能是价格
                        }
                        
                        if (confidence >= 0.3) { // 提高阈值至0.3，避免误识别型号中的数字
                            prices.push({ 
                                price: num, 
                                method: 'context', 
                                confidence: confidence,
                                position: numInfo.position
                            });
                        }
                    }
                }
                
                return prices;
            }
            
            function getPriceContext(line, number, position) {
                const index = position;
                const before = line.substring(Math.max(0, index - 40), index);
                const after = line.substring(index + number.length, Math.min(line.length, index + number.length + 40));
                
                let confidence = 0.2;
                let context = '';
                
                const charBefore = line[index - 1] || '';
                const charAfter = line[index + number.length] || '';
                const next5Chars = line.substring(index + number.length, index + number.length + 5);
                const hasChinese = /[\u4e00-\u9fa5]/.test(next5Chars);
                
                const isLetterBefore = /[A-Z]/i.test(charBefore);
                const isLetterAfter = /[A-Z]/i.test(charAfter);
                
                const shouldPenalizeAfter = isLetterAfter || (!hasChinese && /[A-Z]/i.test(next5Chars));
                
                if (isLetterBefore && shouldPenalizeAfter) {
                    confidence -= 0.7;
                    context += '前后字母嵌入 ';
                } else if (shouldPenalizeAfter) {
                    confidence -= 0.6;
                    context += '后面字母 ';
                } else if (isLetterBefore) {
                    confidence -= 0.4;
                    context += '前面字母 ';
                }
                
                if (charAfter === '-') {
                    confidence -= 0.4;
                    context += '后面横杠 ';
                }
                
                if (charAfter === '+') {
                    confidence -= 0.4;
                    context += '后面加号 ';
                }
                
                if (charBefore === '+') {
                    confidence -= 0.2;
                    context += '前面加号 ';
                }
                if (charBefore === '-') {
                    confidence -= 0.1;
                    context += '前面横杠 ';
                }
                
                if (before.match(/[\/:]$/)) {
                    confidence += 0.4;
                    context += '有分隔符 ';
                } else if (before.match(/\s$/)) {
                    confidence += 0.3;
                    context += '有空格 ';
                }
                
                if (before.match(/(含票|价格|报价|￥|\$)/)) {
                    confidence += 0.4;
                    context += '有价格关键词 ';
                }
                
                if (after.match(/^(元|块|包邮|起|\()/)) {
                    confidence += 0.3;
                    context += '有价格单位 ';
                }
                
                const distanceFromEnd = line.length - index - number.length;
                if (distanceFromEnd < 10) {
                    confidence += 0.5;
                    context += '行末 ';
                } else if (distanceFromEnd < 100) {
                    confidence += 0.3;
                    context += '接近行末 ';
                }
                
                const beforeBracket = line.substring(0, index);
                const afterBracket = line.substring(index);
                if (beforeBracket.includes('(') && afterBracket.includes(')')) {
                    confidence -= 0.2;
                    context += '括号内 ';
                }
                
                return {
                    confidence: Math.max(0, Math.min(1, confidence)),
                    context: context.trim()
                };
            }
            
            function processPrices(line, prices) {
                if (!prices || prices.length === 0) return null;
                
                const uniquePrices = removeDuplicatePrices(prices);
                
                let productName = line;
                uniquePrices.forEach(priceInfo => {
                    const priceStr = priceInfo.price.toString();
                    
                    if (priceInfo.method === 'currency') {
                        productName = productName.replace(new RegExp(`[¥￥]\\s*${priceStr}`, 'g'), '').trim();
                    } else if (priceInfo.method === 'unit') {
                        productName = productName.replace(new RegExp(`${priceStr}\\s*(元|块|台|多|起|限|特)`, 'g'), '').trim();
                    } else {
                        productName = productName.replace(new RegExp(`(?<!\\w)${priceStr}(?!\\w)`, 'g'), '').trim();
                    }
                });
                
                return uniquePrices.map(priceInfo => {
                    return {
                        name: productName,
                        price: priceInfo.price
                    };
                });
            }
            
            function removeDuplicatePrices(prices) {
                prices.sort((a, b) => a.position - b.position);
                
                let uniquePrices = [];
                for (let i = 0; i < prices.length; i++) {
                    const current = prices[i];
                    const isDuplicate = uniquePrices.some(existing => 
                        Math.abs(existing.price - current.price) < 1 && 
                        Math.abs(existing.position - current.position) < 5
                    );
                    
                    if (!isDuplicate) {
                        uniquePrices.push(current);
                    }
                }
                
                return uniquePrices;
            }
            
            function updateStats() {
                const total = parsedItems.length;
                const priceLines = parsedItems.filter(item => item.hasPrice).length;
                const textLines = total - priceLines;
                
                document.getElementById('pm_totalLines').textContent = total;
                document.getElementById('pm_priceLines').textContent = priceLines;
                document.getElementById('pm_textLines').textContent = textLines;
            }
            
            function enterBatchDeleteMode() {
                batchDeleteMode = true;
                document.getElementById('pm_batchDeleteBtn').style.display = 'none';
                document.getElementById('pm_deleteSelectedBtn').style.display = 'inline-block';
                document.getElementById('pm_cancelDeleteBtn').style.display = 'inline-block';
                document.getElementById('pm_copyBtn').disabled = true;
                document.getElementById('pm_parseBtn').disabled = true;
                document.getElementById('pm_sortSelect').disabled = true;
                
                displayItems(parsedItems);
            }
            
            function exitBatchDeleteMode() {
                batchDeleteMode = false;
                document.getElementById('pm_batchDeleteBtn').style.display = 'inline-block';
                document.getElementById('pm_deleteSelectedBtn').style.display = 'none';
                document.getElementById('pm_cancelDeleteBtn').style.display = 'none';
                document.getElementById('pm_copyBtn').disabled = false;
                document.getElementById('pm_parseBtn').disabled = false;
                document.getElementById('pm_sortSelect').disabled = false;
                
                parsedItems.forEach(item => {
                    item.selected = false;
                });
                
                displayItems(parsedItems);
            }
            
            function deleteSelectedItems() {
                const remainingItems = parsedItems.filter(item => !item.selected);
                
                if (remainingItems.length === parsedItems.length) {
                    alert('请选择要删除的项目');
                    return;
                }
                
                parsedItems = remainingItems;
                updateStats();
                exitBatchDeleteMode();
                sortAndDisplayItems();
            }
            
            function sortAndDisplayItems() {
                const sortMethod = document.getElementById('pm_sortSelect').value;
                let sortedItems = [...parsedItems];
                
                switch (sortMethod) {
                    case 'priceAsc':
                        sortedItems.sort((a, b) => {
                            if (!a.hasPrice && b.hasPrice) return 1;
                            if (a.hasPrice && !b.hasPrice) return -1;
                            if (a.hasPrice && b.hasPrice) return a.price - b.price;
                            return 0;
                        });
                        break;
                    case 'priceDesc':
                        sortedItems.sort((a, b) => {
                            if (!a.hasPrice && b.hasPrice) return 1;
                            if (a.hasPrice && !b.hasPrice) return -1;
                            if (a.hasPrice && b.hasPrice) return b.price - a.price;
                            return 0;
                        });
                        break;
                    case 'nameAsc':
                        sortedItems.sort((a, b) => {
                            return a.name.localeCompare(b.name, 'zh-CN');
                        });
                        break;
                    default:
                        break;
                }
                
                displayItems(sortedItems);
            }
            
            function displayItems(items) {
                const resultsContainer = document.getElementById('pm_resultsContainer');
                resultsContainer.innerHTML = '';
                
                resultsContainer.style.overflowY = 'auto';
                resultsContainer.style.maxHeight = '60vh';
                
                items.forEach((item, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = `result-item ${item.selected ? 'selected' : ''}`;
                    resultItem.dataset.index = index;
                    
                    // 复选框
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = `checkbox ${batchDeleteMode ? '' : 'hidden'}`;
                    checkbox.checked = item.selected;
                    checkbox.addEventListener('change', (e) => {
                        parsedItems.forEach(pItem => {
                            if (pItem.originalLine === item.originalLine) {
                                pItem.selected = e.target.checked;
                            }
                        });
                        resultItem.classList.toggle('selected', e.target.checked);
                    });
                    
                    // 拖拽手柄
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '≡';
                    dragHandle.title = '拖拽移动';
                    
                    // 移动按钮
                    const moveButtons = document.createElement('div');
                    moveButtons.className = 'move-buttons';
                    
                    const moveUpBtn = document.createElement('button');
                    moveUpBtn.className = 'move-btn';
                    moveUpBtn.innerHTML = '↑';
                    moveUpBtn.title = '向上移动';
                    moveUpBtn.disabled = index === 0;
                    moveUpBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        moveItemUp(index);
                    });
                    
                    const moveDownBtn = document.createElement('button');
                    moveDownBtn.className = 'move-btn';
                    moveDownBtn.innerHTML = '↓';
                    moveDownBtn.title = '向下移动';
                    moveDownBtn.disabled = index === items.length - 1;
                    moveDownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        moveItemDown(index);
                    });
                    
                    moveButtons.appendChild(moveUpBtn);
                    moveButtons.appendChild(moveDownBtn);
                    
                    // 内容区域
                    const itemContent = document.createElement('div');
                    itemContent.className = 'item-content';
                    
                    const itemText = document.createElement('div');
                    itemText.className = 'item-text';
                    itemText.style.cursor = 'pointer';
                    itemText.style.padding = '8px';
                    itemText.style.borderRadius = '4px';
                    itemText.style.transition = 'background-color 0.2s';
                    
                    // 添加悬停效果
                    itemText.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f0f8ff';
                    });
                    itemText.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    // 添加点击编辑功能
                    itemText.addEventListener('click', function() {
                        editItemContent(item, index, this);
                    });
                    
                    const priceDisplayDiv = document.createElement('div');
                    priceDisplayDiv.className = 'price-display';
                    
                    if (item.hasPrice) {
                        itemText.textContent = item.originalLine;
                        
                        const bluePriceSpan = document.createElement('span');
                        bluePriceSpan.className = 'blue-price';
                        bluePriceSpan.textContent = `¥${item.price}`;
                        priceDisplayDiv.appendChild(bluePriceSpan);
                    } else {
                        itemText.textContent = item.name;
                        
                        const noPriceSpan = document.createElement('span');
                        noPriceSpan.className = 'no-price';
                        noPriceSpan.textContent = '无价格';
                        priceDisplayDiv.appendChild(noPriceSpan);
                    }
                    
                    itemContent.appendChild(itemText);
                    itemContent.appendChild(priceDisplayDiv);
                    
                    // 组装元素
                    resultItem.appendChild(checkbox);
                    resultItem.appendChild(dragHandle);
                    resultItem.appendChild(itemContent);
                    resultItem.appendChild(moveButtons);
                    
                    // 拖拽功能
                    setupDragAndDrop(resultItem, index);
                    
                    // 批量删除模式
                    if (batchDeleteMode) {
                        resultItem.addEventListener('click', (e) => {
                            if (e.target !== checkbox && !e.target.closest('.price-display') && 
                                !e.target.closest('.move-buttons') && !e.target.closest('.drag-handle')) {
                                checkbox.checked = !checkbox.checked;
                                const event = new Event('change');
                                checkbox.dispatchEvent(event);
                            }
                        });
                    }
                    
                    resultsContainer.appendChild(resultItem);
                });
            }
            
            // ========== 列表项移动功能 ==========
            function moveItemUp(index) {
                if (index === 0) return;
                
                // 交换数组元素
                [parsedItems[index], parsedItems[index - 1]] = [parsedItems[index - 1], parsedItems[index]];
                
                // 重新显示列表
                sortAndDisplayItems();
            }
            
            function moveItemDown(index) {
                if (index === parsedItems.length - 1) return;
                
                // 交换数组元素
                [parsedItems[index], parsedItems[index + 1]] = [parsedItems[index + 1], parsedItems[index]];
                
                // 重新显示列表
                sortAndDisplayItems();
            }
            
            function setupDragAndDrop(element, index) {
                const dragHandle = element.querySelector('.drag-handle');
                let draggedElement = null;
                let draggedIndex = null;
                let isDragging = false;
                let autoScrollInterval = null;
                let scrollSpeed = 0;
                
                // 开始拖拽
                const startDrag = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    draggedElement = element;
                    draggedIndex = index;
                    isDragging = true;
                    
                    // 创建拖拽时的视觉元素（克隆）
                    const dragClone = element.cloneNode(true);
                    const rect = element.getBoundingClientRect();
                    
                    dragClone.style.position = 'fixed';
                    dragClone.style.top = rect.top + 'px';
                    dragClone.style.left = rect.left + 'px';
                    dragClone.style.width = rect.width + 'px';
                    dragClone.style.height = rect.height + 'px';
                    dragClone.style.opacity = '0.8';
                    dragClone.style.zIndex = '1000';
                    dragClone.style.pointerEvents = 'none';
                    dragClone.style.transform = 'rotate(2deg)';
                    dragClone.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                    dragClone.style.transition = 'none';
                    dragClone.id = 'drag-clone';
                    
                    // 隐藏原始元素
                    element.style.opacity = '0.3';
                    
                    // 添加到body
                    document.body.appendChild(dragClone);
                    
                    console.log('开始拖拽:', index);
                    
                    // 添加事件监听
                    document.addEventListener('mousemove', handleMove);
                    document.addEventListener('mouseup', handleEnd);
                    document.addEventListener('touchmove', handleTouchMove, { passive: false });
                    document.addEventListener('touchend', handleTouchEnd);
                    document.addEventListener('touchcancel', handleTouchEnd);
                };
                
                // 触摸移动处理
                function handleTouchMove(e) {
                    if (!isDragging) return;
                    
                    const clientX = e.touches[0].clientX;
                    const clientY = e.touches[0].clientY;
                    
                    // 让拖拽元素跟随手指移动
                    updateDragElementPosition(clientX, clientY);
                    
                    // 更新目标高亮（精确跟随手指位置）
                    updateTargetHighlightAtPosition(clientX, clientY);
                    
                    // 检测边缘并自动滚动
                    checkAutoScroll(clientY);
                    
                    // 允许页面滚动，但阻止默认行为
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // 鼠标移动处理
                function handleMove(e) {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const clientX = e.clientX;
                    const clientY = e.clientY;
                    
                    // 让拖拽元素跟随鼠标移动
                    updateDragElementPosition(clientX, clientY);
                    
                    // 更新目标高亮（精确跟随鼠标位置）
                    updateTargetHighlightAtPosition(clientX, clientY);
                    
                    // 检测边缘并自动滚动
                    checkAutoScroll(clientY);
                }
                
                // 边缘检测和自动滚动（以解析框为基准）
                function checkAutoScroll(clientY) {
                    const resultsContainer = document.getElementById('pm_resultsContainer');
                    const containerRect = resultsContainer.getBoundingClientRect();
                    
                    // 计算触摸点相对于解析框的位置
                    const relativeY = clientY - containerRect.top;
                    const containerHeight = containerRect.height;
                    
                    // 如果触摸点不在解析框内，停止滚动
                    if (relativeY < 0 || relativeY > containerHeight) {
                        if (autoScrollInterval) {
                            clearInterval(autoScrollInterval);
                            autoScrollInterval = null;
                            scrollSpeed = 0;
                        }
                        return;
                    }
                    
                    // 计算相对于解析框的百分比位置
                    const percentage = relativeY / containerHeight;
                    
                    // 停止之前的自动滚动
                    if (autoScrollInterval) {
                        clearInterval(autoScrollInterval);
                        autoScrollInterval = null;
                        scrollSpeed = 0;
                    }
                    
                    // 检测是否在边缘区域（解析框顶部0%-30%或底部60%-100%）
                    // 顶部不保留，底部也不保留，解析框中间为基准，上移或下移30%就可以滑动很快
                    if (percentage >= 0 && percentage < 0.30) {
                        // 解析框顶部0%-30%区域，向上滚动
                        const speed = Math.max(3, Math.round((0.30 - percentage) * 25 + 4)); // 4-9像素/帧
                        startAutoScroll(-speed);
                        console.log('向上滚动，速度:', speed, '位置百分比:', (percentage * 100).toFixed(1) + '%');
                    } else if (percentage > 0.60) {
                        // 解析框底部60%-100%区域，向下滚动
                        const speed = Math.max(3, Math.round((percentage - 0.60) * 25 + 4)); // 4-9像素/帧
                        startAutoScroll(speed);
                        console.log('向下滚动，速度:', speed, '位置百分比:', (percentage * 100).toFixed(1) + '%');
                    }
                }
                
                // 开始自动滚动
                function startAutoScroll(speed) {
                    if (autoScrollInterval) return;
                    
                    scrollSpeed = speed;
                    const resultsContainer = document.getElementById('pm_resultsContainer');
                    
                    autoScrollInterval = setInterval(() => {
                        if (!isDragging) {
                            clearInterval(autoScrollInterval);
                            autoScrollInterval = null;
                            return;
                        }
                        
                        // 执行滚动
                        resultsContainer.scrollTop += scrollSpeed;
                        
                        // 更新目标高亮
                        updateTargetHighlight();
                    }, 16); // 约60fps
                }
                
                // 更新拖拽元素位置（让元素跟随手指/鼠标移动）
                function updateDragElementPosition(clientX, clientY) {
                    const dragClone = document.getElementById('drag-clone');
                    if (!dragClone || !draggedElement) return;
                    
                    // 获取拖拽按钮的位置
                    const dragHandle = draggedElement.querySelector('.drag-handle');
                    if (!dragHandle) return;
                    
                    const handleRect = dragHandle.getBoundingClientRect();
                    
                    // 计算手指相对于拖拽按钮的偏移
                    const offsetX = clientX - handleRect.left;
                    const offsetY = clientY - handleRect.top;
                    
                    // 设置克隆元素位置，保持与拖拽按钮的相对位置
                    dragClone.style.left = (handleRect.left + offsetX - handleRect.width) + 'px';
                    dragClone.style.top = (handleRect.top + offsetY) + 'px';
                }
                
                
                // 更新目标高亮（精确跟随手指/鼠标位置）
                function updateTargetHighlightAtPosition(clientX, clientY) {
                    if (!isDragging) return;
                    
                    // 清除之前的高亮和指示线
                    clearAllHighlights();
                    
                    // 在手指/鼠标位置检测目标元素
                    const elementBelow = document.elementFromPoint(clientX, clientY);
                    const resultItem = elementBelow?.closest('.result-item');
                    
                    if (resultItem && resultItem !== draggedElement) {
                        // 创建插入指示线
                        createInsertIndicator(resultItem, clientY);
                    }
                }
                
                // 清除所有高亮和指示线
                function clearAllHighlights() {
                    // 清除行高亮
                    document.querySelectorAll('.result-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    
                    // 清除插入指示线
                    const existingIndicator = document.querySelector('.insert-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                }
                
                // 创建插入指示线
                function createInsertIndicator(targetItem, clientY) {
                    const targetRect = targetItem.getBoundingClientRect();
                    const targetCenterY = targetRect.top + targetRect.height / 2;
                    
                    // 判断插入位置：在目标元素上方还是下方
                    const insertAbove = clientY < targetCenterY;
                    
                    // 创建指示线元素
                    const indicator = document.createElement('div');
                    indicator.className = 'insert-indicator';
                    
                    // 插入到目标位置
                    if (insertAbove) {
                        targetItem.parentNode.insertBefore(indicator, targetItem);
                    } else {
                        targetItem.parentNode.insertBefore(indicator, targetItem.nextSibling);
                    }
                }
                
                // 更新目标高亮
                function updateTargetHighlight() {
                    if (!isDragging) return;
                    
                    const resultsContainer = document.getElementById('pm_resultsContainer');
                    const containerRect = resultsContainer.getBoundingClientRect();
                    const centerX = containerRect.left + containerRect.width / 2;
                    const centerY = containerRect.top + containerRect.height / 2;
                    
                    const elementBelow = document.elementFromPoint(centerX, centerY);
                    const resultItem = elementBelow?.closest('.result-item');
                    
                    if (resultItem && resultItem !== draggedElement) {
                        // 清除之前的高亮
                        document.querySelectorAll('.result-item').forEach(item => {
                            item.classList.remove('drag-over');
                        });
                        
                        // 高亮目标元素
                        resultItem.classList.add('drag-over');
                    }
                }
                
                // 检查最终位置
                function checkFinalPosition() {
                    if (!isDragging) return;
                    
                    const resultsContainer = document.getElementById('pm_resultsContainer');
                    const containerRect = resultsContainer.getBoundingClientRect();
                    const centerX = containerRect.left + containerRect.width / 2;
                    const centerY = containerRect.top + containerRect.height / 2;
                    
                    const elementBelow = document.elementFromPoint(centerX, centerY);
                    const targetElement = elementBelow?.closest('.result-item');
                    
                    if (targetElement && targetElement !== draggedElement) {
                        const targetIndex = parseInt(targetElement.dataset.index);
                        
                        if (targetIndex !== draggedIndex) {
                            // 移动元素
                            const item = parsedItems.splice(draggedIndex, 1)[0];
                            parsedItems.splice(targetIndex, 0, item);
                            
                            // 重新显示
                            sortAndDisplayItems();
                        }
                    }
                }
                
                // 触摸结束处理
                function handleTouchEnd(e) {
                    if (!isDragging) return;
                    handleEnd(e);
                }
                
                // 结束拖拽
                function handleEnd(e) {
                    if (!isDragging) return;
                    
                    console.log('结束拖拽');
                    
                    // 停止自动滚动
                    if (autoScrollInterval) {
                        clearInterval(autoScrollInterval);
                        autoScrollInterval = null;
                    }
                    
                    // 基于插入指示线位置进行交换
                    const insertIndicator = document.querySelector('.insert-indicator');
                    if (insertIndicator) {
                        // 获取插入指示线的位置
                        const indicatorNextSibling = insertIndicator.nextSibling;
                        const indicatorPreviousSibling = insertIndicator.previousSibling;
                        
                        let targetIndex;
                        
                        if (indicatorNextSibling && indicatorNextSibling.classList && indicatorNextSibling.classList.contains('result-item')) {
                            // 指示线在目标元素上方，插入到目标元素的位置
                            targetIndex = parseInt(indicatorNextSibling.dataset.index);
                        } else if (indicatorPreviousSibling && indicatorPreviousSibling.classList && indicatorPreviousSibling.classList.contains('result-item')) {
                            // 指示线在目标元素下方，插入到目标元素的下一个位置
                            targetIndex = parseInt(indicatorPreviousSibling.dataset.index) + 1;
                        } else {
                            // 如果找不到相邻元素，尝试通过父容器查找
                            const container = insertIndicator.parentNode;
                            const allItems = container.querySelectorAll('.result-item');
                            
                            // 找到指示线在DOM中的位置
                            let indicatorPosition = -1;
                            for (let i = 0; i < container.children.length; i++) {
                                if (container.children[i] === insertIndicator) {
                                    indicatorPosition = i;
                                    break;
                                }
                            }
                            
                            if (indicatorPosition >= 0) {
                                // 计算应该插入到哪个位置
                                let itemCount = 0;
                                for (let i = 0; i < indicatorPosition; i++) {
                                    if (container.children[i].classList.contains('result-item')) {
                                        itemCount++;
                                    }
                                }
                                targetIndex = itemCount;
                            }
                        }
                        
                        if (targetIndex !== undefined && targetIndex !== draggedIndex) {
                            // 移动数组元素
                            const item = parsedItems.splice(draggedIndex, 1)[0];
                            
                            // 向下拖拽时需要调整目标索引（因为splice删除后，后续索引减1）
                            let adjustedTargetIndex = targetIndex;
                            if (draggedIndex < targetIndex) {
                                adjustedTargetIndex = targetIndex - 1;
                            }
                            
                            parsedItems.splice(adjustedTargetIndex, 0, item);
                            
                            // 重新显示列表
                            sortAndDisplayItems();
                            
                            console.log('元素已插入到位置:', adjustedTargetIndex, '(原目标:', targetIndex, ', 拖拽起始:', draggedIndex, ')');
                        }
                    } else {
                        // 如果没有插入指示线，使用原来的逻辑作为备用
                        let clientX, clientY;
                        if (e.type === 'touchend' && e.changedTouches && e.changedTouches.length > 0) {
                            clientX = e.changedTouches[0].clientX;
                            clientY = e.changedTouches[0].clientY;
                        } else if (e.type === 'mouseup') {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        }
                        
                        if (clientX && clientY) {
                            const elementBelow = document.elementFromPoint(clientX, clientY);
                            const targetElement = elementBelow?.closest('.result-item');
                            
                            if (targetElement && targetElement !== draggedElement) {
                                const targetIndex = parseInt(targetElement.dataset.index);
                                const draggedIndex = parseInt(draggedElement.dataset.index);
                                
                                if (targetIndex !== draggedIndex) {
                                    // 交换数组元素
                                    const item = parsedItems.splice(draggedIndex, 1)[0];
                                    parsedItems.splice(targetIndex, 0, item);
                                    
                                    // 重新显示列表
                                    sortAndDisplayItems();
                                    
                                    console.log('元素已移动到位置:', targetIndex);
                                }
                            }
                        }
                    }
                    
                    // 清理
                    cleanup();
                }
                
                // 清理
                function cleanup() {
                    // 移除克隆元素
                    const dragClone = document.getElementById('drag-clone');
                    if (dragClone) {
                        dragClone.remove();
                    }
                    
                    // 重置原始元素样式
                    if (draggedElement) {
                        draggedElement.style.opacity = '';
                    }
                    
                    // 清除所有高亮和指示线
                    clearAllHighlights();
                    
                    // 重置状态
                    draggedElement = null;
                    draggedIndex = null;
                    isDragging = false;
                    
                    // 停止自动滚动
                    if (autoScrollInterval) {
                        clearInterval(autoScrollInterval);
                        autoScrollInterval = null;
                    }
                    
                    // 移除事件监听
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                    document.removeEventListener('touchcancel', handleTouchEnd);
                }
                
                // 绑定事件
                dragHandle.addEventListener('mousedown', startDrag);
                dragHandle.addEventListener('touchstart', startDrag, { passive: false });
                
                // 防止默认行为
                dragHandle.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                });
            }
            
            function copyResults() {
                // 获取当前排序后的数据，而不是原始数据
                const sortMethod = document.getElementById('pm_sortSelect').value;
                let sortedItems = [...parsedItems];
                
                // 应用与显示时相同的排序逻辑
                switch (sortMethod) {
                    case 'priceAsc':
                        sortedItems.sort((a, b) => {
                            if (!a.hasPrice && b.hasPrice) return 1;
                            if (a.hasPrice && !b.hasPrice) return -1;
                            if (a.hasPrice && b.hasPrice) return a.price - b.price;
                            return 0;
                        });
                        break;
                    case 'priceDesc':
                        sortedItems.sort((a, b) => {
                            if (!a.hasPrice && b.hasPrice) return 1;
                            if (a.hasPrice && !b.hasPrice) return -1;
                            if (a.hasPrice && b.hasPrice) return b.price - a.price;
                            return 0;
                        });
                        break;
                    case 'nameAsc':
                        sortedItems.sort((a, b) => {
                            return a.name.localeCompare(b.name, 'zh-CN');
                        });
                        break;
                    default:
                        // 原始顺序，不需要排序
                        break;
                }
                
                const resultText = sortedItems.map(item => item.originalLine).join('\n');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(resultText)
                        .then(() => {
                            showCopySuccess();
                        })
                        .catch(err => {
                            fallbackCopy(resultText);
                        });
                } else {
                    fallbackCopy(resultText);
                }
            }
            
            function showCopySuccess() {
                const copySuccess = document.getElementById('pm_copySuccess');
                copySuccess.classList.add('show');
                setTimeout(() => {
                    copySuccess.classList.remove('show');
                }, 2000);
            }
            
            function fallbackCopy(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showCopySuccess();
                } catch (err) {
                    console.error('复制失败: ', err);
                } finally {
                    document.body.removeChild(textArea);
                }
            }
            
            // 编辑项目内容功能
            function editItemContent(item, index, contentElement) {
                // 创建编辑模态框
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    width: 100%;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                const title = document.createElement('h3');
                title.textContent = '编辑内容';
                title.style.cssText = `
                    margin: 0 0 15px 0;
                    color: #333;
                    font-size: 18px;
                `;
                
                const textarea = document.createElement('textarea');
                textarea.value = item.originalLine;
                
                // 根据当前字体大小设置动态调整
                let fontSize = '16px'; // 默认中字体
                if (document.body.classList.contains('font-small')) {
                    fontSize = '14px';
                } else if (document.body.classList.contains('font-large')) {
                    fontSize = '18px';
                } else if (document.body.classList.contains('font-extra-large')) {
                    fontSize = '24px';
                }
                
                textarea.style.cssText = `
                    width: 100%;
                    min-height: 120px;
                    padding: 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    font-size: ${fontSize};
                    resize: vertical;
                    box-sizing: border-box;
                `;
                textarea.focus();
                textarea.select();
                
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                    justify-content: flex-end;
                `;
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '取消';
                cancelBtn.style.cssText = `
                    padding: 10px 20px;
                    background: #95a5a6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                
                const saveBtn = document.createElement('button');
                saveBtn.textContent = '保存';
                saveBtn.style.cssText = `
                    padding: 10px 20px;
                    background: #3498db;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                
                // 事件处理
                const closeModal = () => {
                    document.body.removeChild(modal);
                };
                
                cancelBtn.addEventListener('click', closeModal);
                
                saveBtn.addEventListener('click', () => {
                    const newContent = textarea.value.trim();
                    if (newContent && newContent !== item.originalLine) {
                        // 更新原始数据
                        item.originalLine = newContent;
                        item.name = newContent;
                        
                        // 重新解析价格
                        const result = parseProducts(newContent);
                        if (result && result.hasPrice && result.prices && result.prices.length > 0) {
                            item.hasPrice = true;
                            item.price = result.prices[0].price;
                        } else {
                            item.hasPrice = false;
                            item.price = null;
                        }
                        
                        // 更新统计信息
                        updateStats();
                        
                        // 重新显示列表
                        sortAndDisplayItems();
                        
                        // 显示成功提示
                        showEditSuccess();
                    }
                    closeModal();
                });
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // ESC键关闭
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                
                // 组装模态框
                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(saveBtn);
                modalContent.appendChild(title);
                modalContent.appendChild(textarea);
                modalContent.appendChild(buttonContainer);
                modal.appendChild(modalContent);
                
                // 显示模态框
                document.body.appendChild(modal);
            }
            
            // 显示编辑成功提示
            function showEditSuccess() {
                const toast = document.createElement('div');
                toast.textContent = '✓ 内容已更新';
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }
            
            return {
                init: init
            };
        })();
        
        // ========== 界面2：价格调整 JavaScript ==========
        const PriceAdjuster = (function() {
            let parsedData = [];
            let isPricingApplied = false;
            
            function init() {
                // 初始化完成
            }
            
            function parseProducts() {
                const input = document.getElementById('pa_productInput').value.trim();
                if (!input) {
                    alert('请输入产品信息');
                    return;
                }
                
                const lines = input.split('\n').filter(line => line.trim());
                parsedData = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const result = purePriceParse(line);
                    parsedData.push(result);
                }
                
                displayResults();
                updateStats();
            }
            
            function purePriceParse(line) {
                if (isNonProductLine(line)) {
                    return {
                        original: line,
                        hasPrice: false,
                        prices: [],
                        content: line,
                        type: 'text',
                        debug: { method: 'non-product' }
                    };
                }
                
                let allPrices = [];
                let explicitPrices = findExplicitPrices(line);
                allPrices = allPrices.concat(explicitPrices);
                
                let contextPrices = findContextPrices(line);
                allPrices = allPrices.concat(contextPrices);
                
                allPrices = removeDuplicatePrices(allPrices);
                
                if (allPrices.length > 0) {
                    allPrices.sort((a, b) => b.position - a.position);
                    const singlePrice = [allPrices[0]];
                    
                    return {
                        original: line,
                        hasPrice: true,
                        prices: singlePrice,
                        content: line,
                        type: 'product',
                        debug: { method: 'single-price', count: 1 }
                    };
                }
                
                return {
                    original: line,
                    hasPrice: false,
                    prices: [],
                    content: line,
                    type: 'text',
                    debug: { method: 'no-price' }
                };
            }
            
            function findExplicitPrices(line) {
                let prices = [];
                let currencyPattern = /[¥$]\s*(\d+(?:\.\d+)?)/g;
                let match;
                while ((match = currencyPattern.exec(line)) !== null) {
                    const price = parseFloat(match[1]);
                    if (price >= 199 && price <= 99999) {
                        prices.push({ price: price, method: 'currency', position: match.index });
                    }
                }
                
                let unitPattern = /(\d+(?:\.\d+)?)\s*(元|块|台|多|起|限|特)/g;
                while ((match = unitPattern.exec(line)) !== null) {
                    const price = parseFloat(match[1]);
                    if (price >= 199 && price <= 99999) {
                        prices.push({ price: price, method: 'unit', position: match.index });
                    }
                }
                
                // 带表情符号的价格识别已移除，避免6XXX价格识别错误
                
                return prices;
            }
            
            function findContextPrices(line) {
                let prices = [];
                const numbersWithPosition = [];
                let regex = /\d{3,}/g;
                let match;
                while ((match = regex.exec(line)) !== null) {
                    numbersWithPosition.push({
                        num: match[0],
                        value: parseInt(match[0]),
                        position: match.index
                    });
                }
                
                numbersWithPosition.sort((a, b) => b.position - a.position);
                
                for (let i = 0; i < numbersWithPosition.length; i++) {
                    const numInfo = numbersWithPosition[i];
                    const num = numInfo.value;
                    
                    if (num >= 199 && num <= 99999) {
                        const context = getPriceContext(line, numInfo.num, numInfo.position);
                        let confidence = context.confidence;
                        
                        const beforeNum = line.substring(Math.max(0, numInfo.position - 5), numInfo.position);
                        if (beforeNum.includes('/')) {
                            confidence += 0.2;
                        }
                        
                        const afterNum = line.substring(numInfo.position + numInfo.num.length, Math.min(line.length, numInfo.position + numInfo.num.length + 5));
                        if (afterNum.includes('(') || afterNum.includes(')')) {
                            confidence += 0.1;
                        }
                        
                        if (confidence >= 0.3) {
                            prices.push({ 
                                price: num, 
                                method: 'context', 
                                confidence: confidence,
                                position: numInfo.position
                            });
                        }
                    }
                }
                
                return prices;
            }
            
            function getPriceContext(line, number, position) {
                const index = position;
                const before = line.substring(Math.max(0, index - 40), index);
                const after = line.substring(index + number.length, Math.min(line.length, index + number.length + 40));
                
                let confidence = 0.2;
                let context = '';
                
                const charBefore = line[index - 1] || '';
                const charAfter = line[index + number.length] || '';
                const next5Chars = line.substring(index + number.length, index + number.length + 5);
                const hasChinese = /[\u4e00-\u9fa5]/.test(next5Chars);
                
                const isLetterBefore = /[A-Z]/i.test(charBefore);
                const isLetterAfter = /[A-Z]/i.test(charAfter);
                
                const shouldPenalizeAfter = isLetterAfter || (!hasChinese && /[A-Z]/i.test(next5Chars));
                
                if (isLetterBefore && shouldPenalizeAfter) {
                    confidence -= 0.7;
                    context += '前后字母嵌入 ';
                } else if (shouldPenalizeAfter) {
                    confidence -= 0.6;
                    context += '后面字母 ';
                } else if (isLetterBefore) {
                    confidence -= 0.4;
                    context += '前面字母 ';
                }
                
                if (charAfter === '-') {
                    confidence -= 0.4;
                    context += '后面横杠 ';
                }
                
                if (charAfter === '+') {
                    confidence -= 0.4;
                    context += '后面加号 ';
                }
                
                if (charBefore === '+') {
                    confidence -= 0.2;
                    context += '前面加号 ';
                }
                if (charBefore === '-') {
                    confidence -= 0.1;
                    context += '前面横杠 ';
                }
                
                if (before.match(/[\/:]$/)) {
                    confidence += 0.4;
                    context += '有分隔符 ';
                } else if (before.match(/\s$/)) {
                    confidence += 0.3;
                    context += '有空格 ';
                }
                
                if (before.match(/(含票|价格|报价|￥|\$)/)) {
                    confidence += 0.4;
                    context += '有价格关键词 ';
                }
                
                if (after.match(/^(元|块|包邮|起|\()/)) {
                    confidence += 0.3;
                    context += '有价格单位 ';
                }
                
                const distanceFromEnd = line.length - index - number.length;
                if (distanceFromEnd < 10) {
                    confidence += 0.5;
                    context += '行末 ';
                } else if (distanceFromEnd < 100) {
                    confidence += 0.3;
                    context += '接近行末 ';
                }
                
                const beforeBracket = line.substring(0, index);
                const afterBracket = line.substring(index);
                if (beforeBracket.includes('(') && afterBracket.includes(')')) {
                    confidence -= 0.2;
                    context += '括号内 ';
                }
                
                return {
                    confidence: Math.max(0, Math.min(1, confidence)),
                    context: context.trim()
                };
            }
            
            function removeDuplicatePrices(prices) {
                prices.sort((a, b) => a.position - b.position);
                
                let uniquePrices = [];
                for (let i = 0; i < prices.length; i++) {
                    const current = prices[i];
                    const isDuplicate = uniquePrices.some(existing => 
                        Math.abs(existing.price - current.price) < 1 && 
                        Math.abs(existing.position - current.position) < 5
                    );
                    
                    if (!isDuplicate) {
                        uniquePrices.push(current);
                    }
                }
                
                return uniquePrices;
            }
            
            function applyPricing() {
                if (parsedData.length === 0) {
                    alert('请先解析产品');
                    return;
                }
                
                const pricingType = document.getElementById('pa_pricingType').value;
                const pricingMode = document.getElementById('pa_pricingMode').value;
                const pricingDirection = document.getElementById('pa_pricingDirection').value;
                const priceRounding = document.getElementById('pa_priceRounding').value;
                
                // 只有在统一调价模式下才需要获取统一的调价值
                let pricingValue = 0;
                if (pricingMode === 'uniform') {
                    pricingValue = parseFloat(document.getElementById('pa_pricingValue').value);
                }
                
                for (let item of parsedData) {
                    if (item.hasPrice && item.prices && item.prices.length > 0) {
                        item.newPrices = [];
                        
                        for (let priceInfo of item.prices) {
                            let newPrice = priceInfo.price;
                            let currentPricingValue = pricingValue;
                            
                            // 如果是区间调价模式，根据价格区间获取对应的调价百分比
                            if (pricingMode === 'range') {
                                currentPricingValue = getPriceRangePercentage(priceInfo.price);
                            }
                            
                            if (pricingType === 'percentage') {
                                if (pricingDirection === 'increase') {
                                    newPrice = priceInfo.price * (1 + currentPricingValue / 100);
                                } else {
                                    newPrice = priceInfo.price * (1 - currentPricingValue / 100);
                                }
                            } else {
                                if (pricingDirection === 'increase') {
                                    newPrice = priceInfo.price + currentPricingValue;
                                } else {
                                    newPrice = priceInfo.price - currentPricingValue;
                                }
                            }
                            
                            newPrice = applyRounding(newPrice, priceRounding);
                            item.newPrices.push(newPrice);
                        }
                    }
                }
                
                isPricingApplied = true;
                displayResults();
            }
            
            function applyRounding(price, roundingType) {
                switch (roundingType) {
                    case 'ones':
                        return Math.round(price);
                    case 'tens':
                        return Math.round(price / 10) * 10;
                    case 'hundreds':
                        return Math.round(price / 100) * 100;
                    case 'none':
                    default:
                        return Math.round(price);
                }
            }
            
            // 切换调价模式显示
            function togglePricingMode() {
                const mode = document.getElementById('pa_pricingMode').value;
                const rangeSection = document.getElementById('pa_rangePricingSection');
                
                if (mode === 'range') {
                    rangeSection.style.display = 'block';
                } else {
                    rangeSection.style.display = 'none';
                }
            }
            
            // 根据价格获取对应的区间调价百分比
            function getPriceRangePercentage(price) {
                // 获取各区间的调价百分比
                const range0_999 = parseFloat(document.getElementById('pa_range0_999').value);
                const range1000_1999 = parseFloat(document.getElementById('pa_range1000_1999').value);
                const range2000_4999 = parseFloat(document.getElementById('pa_range2000_4999').value);
                const range5000_9999 = parseFloat(document.getElementById('pa_range5000_9999').value);
                const range10000_plus = parseFloat(document.getElementById('pa_range10000_plus').value);
                
                // 根据价格区间返回对应的百分比
                if (price >= 0 && price <= 999) {
                    return range0_999;
                } else if (price >= 1000 && price <= 1999) {
                    return range1000_1999;
                } else if (price >= 2000 && price <= 4999) {
                    return range2000_4999;
                } else if (price >= 5000 && price <= 9999) {
                    return range5000_9999;
                } else if (price >= 10000) {
                    return range10000_plus;
                }
                return 0; // 默认值
            }
            
            function displayResults() {
                const resultArea = document.getElementById('pa_resultArea');
                resultArea.innerHTML = '';
                
                for (let item of parsedData) {
                    const itemDiv = document.createElement('div');
                    let itemClass = 'result-item';
                    
                    if (item.hasPrice && item.prices.length > 0) {
                        itemClass += ' has-price';
                    } else {
                        itemClass += ' no-price';
                    }
                    
                    itemDiv.className = itemClass;
                    
                    let content = item.content;
                    let priceDisplay = '';
                    
                    if (item.hasPrice && item.prices.length > 0) {
                        if (isPricingApplied && item.newPrices) {
                            priceDisplay = item.prices.map((priceInfo, index) => {
                                const newPrice = item.newPrices[index] || priceInfo.price;
                                const priceChange = newPrice - priceInfo.price;
                                const priceClass = priceChange > 0 ? 'price-increase' : (priceChange < 0 ? 'price-decrease' : '');
                                
                                return `
                                    <span class="result-price original">¥${priceInfo.price}</span>
                                    <span class="result-price new ${priceClass}">¥${newPrice}</span>
                                `;
                            }).join(' ');
                        } else {
                            priceDisplay = item.prices.map(priceInfo => 
                                `<span class="result-price">¥${priceInfo.price}</span>`
                            ).join(' ');
                        }
                    } else {
                        priceDisplay = '<span style="color: #999; font-size: 3vw;">无价格</span>';
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="result-content">${content}</div>
                        <div class="result-price">${priceDisplay}</div>
                    `;
                    
                    resultArea.appendChild(itemDiv);
                }
            }
            
            function updateStats() {
                const totalLines = parsedData.length;
                const priceLines = parsedData.filter(item => item.hasPrice).length;
                const textLines = parsedData.filter(item => !item.hasPrice).length;
                
                document.getElementById('pa_totalLines').textContent = totalLines;
                document.getElementById('pa_priceLines').textContent = priceLines;
                document.getElementById('pa_textLines').textContent = textLines;
            }
            
            function isNonProductLine(line) {
                const nonProductPatterns = [
                    /^————+$/, 
                    /^\[红包\].*\[红包\]$/,
                    /^[\s\-_=]+$/,
                    /平台现查|价格可能会波动/,
                    /全国包邮|深圳|河源|惠州/,
                    /现货秒发|其他机型询价/,
                    /更多其他品牌型号/,
                    /备注：|以上几款|以实际开单为准/,
                    /^\.+$/,
                    /^[一二三四五六七八九十]+、/,
                    /我司产品可开票/
                ];
                return nonProductPatterns.some(pattern => pattern.test(line));
            }
            
            function copyResults() {
                if (parsedData.length === 0) {
                    alert('请先解析产品');
                    return;
                }
                
                let output = [];
                
                for (let item of parsedData) {
                    if (item.hasPrice && item.prices.length > 0) {
                        let content = item.original;
                        let newPrice = item.newPrices && item.newPrices[0] 
                            ? item.newPrices[0] 
                            : item.prices[0].price;
                        
                        content = replacePriceInOriginal(content, item.prices[0], newPrice);
                        output.push(content);
                    } else {
                        output.push(item.original);
                    }
                }
                
                const textToCopy = output.join('\n');
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    fallbackCopy(textToCopy);
                });
            }
            
            function replacePriceInOriginal(content, priceInfo, newPrice) {
                const oldPriceStr = priceInfo.price.toString();
                const position = priceInfo.position;
                const newPriceStr = newPrice.toString();
                
                let start = position;
                let end = position + oldPriceStr.length;
                
                const actualNumber = content.substring(start, end);
                if (actualNumber !== oldPriceStr) {
                    const priceRegex = new RegExp('\\b' + oldPriceStr + '\\b');
                    const match = content.match(priceRegex);
                    if (match) {
                        start = content.indexOf(match[0]);
                        end = start + match[0].length;
                    } else {
                        return content;
                    }
                }
                
                const beforePrice = content.substring(0, start);
                const afterPrice = content.substring(end);
                const result = beforePrice + newPriceStr + afterPrice;
                
                return result;
            }
            
            function showCopySuccess() {
                const toast = document.createElement('div');
                toast.textContent = '✓ 已复制到剪贴板';
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 9999;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }
            
            function fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    showCopySuccess();
                } catch (err) {
                    alert('复制失败，请手动复制');
                }
                
                document.body.removeChild(textarea);
            }
            
            return {
                init: init,
                parseProducts: parseProducts,
                applyPricing: applyPricing,
                copyResults: copyResults,
                togglePricingMode: togglePricingMode
            };
        })();
        
        // ========== 界面3：符号更换 JavaScript ==========
        const SymbolChanger = (function() {
            let parsedData = [];
            let currentPriceSeparator = '¥';
            let enableFooter = false;
            let footerText = '';
            
            function init() {
                // 加载保存的设置
                loadSettings();
                
                // 绑定事件监听器
                document.getElementById('sc_enableFooter').addEventListener('change', function() {
                    enableFooter = this.checked;
                    saveSettings();
                    if (parsedData.length > 0) {
                        displayResults();
                    }
                });
                
                document.getElementById('sc_footerText').addEventListener('input', function() {
                    footerText = this.value;
                    saveSettings();
                });
            }
            
            function loadSettings() {
                // 从localStorage加载设置
                const savedEnableFooter = localStorage.getItem('symbolChanger_enableFooter');
                const savedFooterText = localStorage.getItem('symbolChanger_footerText');
                
                if (savedEnableFooter !== null) {
                    enableFooter = savedEnableFooter === 'true';
                    document.getElementById('sc_enableFooter').checked = enableFooter;
                }
                
                if (savedFooterText !== null) {
                    footerText = savedFooterText;
                    document.getElementById('sc_footerText').value = footerText;
                } else {
                    // 设置默认值
                    footerText = '平台现查，价格可能会有波动，感谢理解！部分产品私聊询价下单，期待合作[握手]';
                    document.getElementById('sc_footerText').value = footerText;
                }
            }
            
            function saveSettings() {
                // 保存设置到localStorage
                localStorage.setItem('symbolChanger_enableFooter', enableFooter.toString());
                localStorage.setItem('symbolChanger_footerText', footerText);
            }
            
            function parseProducts() {
                const input = document.getElementById('sc_productInput').value.trim();
                if (!input) {
                    alert('请输入产品信息');
                    return;
                }
                
                const lines = input.split('\n').filter(line => line.trim());
                parsedData = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const result = purePriceParse(line);
                    parsedData.push(result);
                }
                
                displayResults();
                updateStats();
            }
            
            function purePriceParse(line) {
                if (isNonProductLine(line)) {
                    return {
                        original: line,
                        hasPrice: false,
                        prices: [],
                        content: line,
                        type: 'text'
                    };
                }
                
                let allPrices = [];
                let explicitPrices = findExplicitPrices(line);
                allPrices = allPrices.concat(explicitPrices);
                
                let contextPrices = findContextPrices(line);
                allPrices = allPrices.concat(contextPrices);
                
                allPrices = removeDuplicatePrices(allPrices);
                
                if (allPrices.length > 0) {
                    allPrices.sort((a, b) => b.position - a.position);
                    const singlePrice = [allPrices[0]];
                    
                    return {
                        original: line,
                        hasPrice: true,
                        prices: singlePrice,
                        content: line,
                        type: 'product'
                    };
                }
                
                return {
                    original: line,
                    hasPrice: false,
                    prices: [],
                    content: line,
                    type: 'text'
                };
            }
            
            function findExplicitPrices(line) {
                let prices = [];
                let currencyPattern = /[¥$]\s*(\d+(?:\.\d+)?)/g;
                let match;
                while ((match = currencyPattern.exec(line)) !== null) {
                    const price = parseFloat(match[1]);
                    if (price >= 199 && price <= 99999) {
                        prices.push({ price: price, method: 'currency', position: match.index });
                    }
                }
                
                let unitPattern = /(\d+(?:\.\d+)?)\s*(元|块|台|多|起|限|特)/g;
                while ((match = unitPattern.exec(line)) !== null) {
                    const price = parseFloat(match[1]);
                    if (price >= 199 && price <= 99999) {
                        prices.push({ price: price, method: 'unit', position: match.index });
                    }
                }
                
                // 带表情符号的价格识别已移除，避免6XXX价格识别错误
                
                return prices;
            }
            
            function findContextPrices(line) {
                let prices = [];
                const numbersWithPosition = [];
                let regex = /\d{3,}/g;
                let match;
                while ((match = regex.exec(line)) !== null) {
                    numbersWithPosition.push({
                        num: match[0],
                        value: parseInt(match[0]),
                        position: match.index
                    });
                }
                
                numbersWithPosition.sort((a, b) => b.position - a.position);
                
                for (let i = 0; i < numbersWithPosition.length; i++) {
                    const numInfo = numbersWithPosition[i];
                    const num = numInfo.value;
                    
                    if (num >= 199 && num <= 99999) {
                        const context = getPriceContext(line, numInfo.num, numInfo.position);
                        let confidence = context.confidence;
                        
                        const beforeNum = line.substring(Math.max(0, numInfo.position - 5), numInfo.position);
                        if (beforeNum.includes('/')) {
                            confidence += 0.2;
                        }
                        
                        const afterNum = line.substring(numInfo.position + numInfo.num.length, Math.min(line.length, numInfo.position + numInfo.num.length + 5));
                        if (afterNum.includes('(') || afterNum.includes(')')) {
                            confidence += 0.1;
                        }
                        
                        if (confidence >= 0.3) {
                            prices.push({ 
                                price: num, 
                                method: 'context', 
                                confidence: confidence,
                                position: numInfo.position
                            });
                        }
                    }
                }
                
                return prices;
            }
            
            function getPriceContext(line, number, position) {
                const index = position;
                const before = line.substring(Math.max(0, index - 40), index);
                const after = line.substring(index + number.length, Math.min(line.length, index + number.length + 40));
                
                let confidence = 0.2;
                let context = '';
                
                const charBefore = line[index - 1] || '';
                const charAfter = line[index + number.length] || '';
                const next5Chars = line.substring(index + number.length, index + number.length + 5);
                const hasChinese = /[\u4e00-\u9fa5]/.test(next5Chars);
                
                const isLetterBefore = /[A-Z]/i.test(charBefore);
                const isLetterAfter = /[A-Z]/i.test(charAfter);
                
                const shouldPenalizeAfter = isLetterAfter || (!hasChinese && /[A-Z]/i.test(next5Chars));
                
                if (isLetterBefore && shouldPenalizeAfter) {
                    confidence -= 0.7;
                    context += '前后字母嵌入 ';
                } else if (shouldPenalizeAfter) {
                    confidence -= 0.6;
                    context += '后面字母 ';
                } else if (isLetterBefore) {
                    confidence -= 0.4;
                    context += '前面字母 ';
                }
                
                if (charAfter === '-') {
                    confidence -= 0.4;
                    context += '后面横杠 ';
                }
                
                if (charAfter === '+') {
                    confidence -= 0.4;
                    context += '后面加号 ';
                }
                
                if (charBefore === '+') {
                    confidence -= 0.2;
                    context += '前面加号 ';
                }
                if (charBefore === '-') {
                    confidence -= 0.1;
                    context += '前面横杠 ';
                }
                
                if (before.match(/[\/:]$/)) {
                    confidence += 0.4;
                    context += '有分隔符 ';
                } else if (before.match(/\s$/)) {
                    confidence += 0.3;
                    context += '有空格 ';
                }
                
                if (before.match(/(含票|价格|报价|￥|\$)/)) {
                    confidence += 0.4;
                    context += '有价格关键词 ';
                }
                
                if (after.match(/^(元|块|包邮|起|\()/)) {
                    confidence += 0.3;
                    context += '有价格单位 ';
                }
                
                const distanceFromEnd = line.length - index - number.length;
                if (distanceFromEnd < 10) {
                    confidence += 0.5;
                    context += '行末 ';
                } else if (distanceFromEnd < 100) {
                    confidence += 0.3;
                    context += '接近行末 ';
                }
                
                const beforeBracket = line.substring(0, index);
                const afterBracket = line.substring(index);
                if (beforeBracket.includes('(') && afterBracket.includes(')')) {
                    confidence -= 0.2;
                    context += '括号内 ';
                }
                
                return {
                    confidence: Math.max(0, Math.min(1, confidence)),
                    context: context.trim()
                };
            }
            
            function removeDuplicatePrices(prices) {
                prices.sort((a, b) => a.position - b.position);
                
                let uniquePrices = [];
                for (let i = 0; i < prices.length; i++) {
                    const current = prices[i];
                    const isDuplicate = uniquePrices.some(existing => 
                        Math.abs(existing.price - current.price) < 1 && 
                        Math.abs(existing.position - current.position) < 5
                    );
                    
                    if (!isDuplicate) {
                        uniquePrices.push(current);
                    }
                }
                
                return uniquePrices;
            }
            
            function applyPriceSeparator() {
                const replaceSymbol = document.getElementById('sc_priceSeparator').value;
                currentPriceSeparator = replaceSymbol || '¥';
                redisplayResultsWithSeparator();
                
                const toast = document.createElement('div');
                toast.textContent = '✓ 价格符号已更新';
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 9999;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }
            
            function redisplayResultsWithSeparator() {
                const resultItems = document.querySelectorAll('#symbolChanger .result-item');
                
                parsedData.forEach((item, index) => {
                    if (index < resultItems.length && item.hasPrice && item.prices.length > 0) {
                        const priceElement = resultItems[index].querySelector('.result-price');
                        if (priceElement) {
                            priceElement.textContent = currentPriceSeparator + item.prices[0].price;
                        }
                    }
                });
            }
            
            function displayResults() {
                const resultArea = document.getElementById('sc_resultArea');
                resultArea.innerHTML = '';
                
                updateStats();
                
                for (let item of parsedData) {
                    const itemDiv = document.createElement('div');
                    let itemClass = 'result-item';
                    
                    if (item.hasPrice && item.prices.length > 0) {
                        itemClass += ' has-price';
                    } else {
                        itemClass += ' no-price';
                    }
                    
                    itemDiv.className = itemClass;
                    
                    let content = item.content;
                    
                    const originalText = document.createElement('div');
                    originalText.className = 'result-content';
                    originalText.textContent = content;
                    
                    const priceDisplay = document.createElement('div');
                    priceDisplay.className = 'result-price';
                    
                    if (item.hasPrice && item.prices.length > 0) {
                        priceDisplay.textContent = currentPriceSeparator + item.prices[0].price;
                    } else {
                        priceDisplay.textContent = '';
                    }
                    
                    itemDiv.appendChild(originalText);
                    itemDiv.appendChild(priceDisplay);
                    resultArea.appendChild(itemDiv);
                }
                
                // 在最后添加结尾说明（只添加一次）
                if (enableFooter && footerText.trim()) {
                    const footerDiv = document.createElement('div');
                    footerDiv.className = 'result-item';
                    footerDiv.style.background = '#f0f8ff';
                    footerDiv.style.border = '2px solid #2196F3';
                    footerDiv.style.fontStyle = 'italic';
                    footerDiv.style.color = '#666';
                    footerDiv.style.textAlign = 'center';
                    footerDiv.style.padding = '2vw';
                    footerDiv.style.marginTop = '2vw';
                    
                    const footerTextDiv = document.createElement('div');
                    footerTextDiv.className = 'result-content';
                    footerTextDiv.textContent = footerText.trim();
                    footerTextDiv.style.width = '100%';
                    footerTextDiv.style.textAlign = 'center';
                    
                    footerDiv.appendChild(footerTextDiv);
                    resultArea.appendChild(footerDiv);
                }
            }
            
            function updateStats() {
                const totalLines = parsedData.length;
                const priceLines = parsedData.filter(item => item.hasPrice).length;
                const textLines = parsedData.filter(item => !item.hasPrice).length;
                
                document.getElementById('sc_totalLines').textContent = totalLines;
                document.getElementById('sc_priceLines').textContent = priceLines;
                document.getElementById('sc_textLines').textContent = textLines;
            }
            
            function isNonProductLine(line) {
                const nonProductPatterns = [
                    /^————+$/, 
                    /^\[红包\].*\[红包\]$/,
                    /^[\s\-_=]+$/,
                    /平台现查|价格可能会波动/,
                    /全国包邮|深圳|河源|惠州/,
                    /现货秒发|其他机型询价/,
                    /更多其他品牌型号/,
                    /备注：|以上几款|以实际开单为准/,
                    /^\.+$/,
                    /^[一二三四五六七八九十]+、/,
                    /我司产品可开票/
                ];
                return nonProductPatterns.some(pattern => pattern.test(line));
            }
            
            function copyResults() {
                if (parsedData.length === 0) {
                    alert('请先解析产品');
                    return;
                }
                
                const replaceSymbol = document.getElementById('sc_priceSeparator').value;
                
                let output = [];
                
                for (let item of parsedData) {
                    let lineToAdd = '';
                    
                    if (item.hasPrice && item.prices.length > 0 && replaceSymbol !== '') {
                        const originalLine = item.original;
                        const priceInfo = item.prices[0];
                        const priceValue = priceInfo.price;
                        const priceStr = priceValue.toString();
                        
                        lineToAdd = replacePriceSeparator(originalLine, priceStr, replaceSymbol);
                    } else {
                        lineToAdd = item.original;
                    }
                    
                    output.push(lineToAdd);
                }
                
                // 在最后添加结尾说明（只添加一次）
                let textToCopy = output.join('\n');
                if (enableFooter && footerText.trim()) {
                    textToCopy += '\n' + footerText.trim();
                }
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    fallbackCopy(textToCopy);
                });
            }
            
            function replacePriceSeparator(line, priceStr, replaceSymbol) {
                const priceIndex = line.lastIndexOf(priceStr);
                
                if (priceIndex > 0) {
                    let endIndex = priceIndex; // 价格开始位置
                    let startIndex = priceIndex;
                    
                    // 第一步：向前删除所有空格（处理 [文字] 后的空格）
                    while (startIndex > 0 && /\s/.test(line[startIndex - 1])) {
                        startIndex--;
                    }
                    
                    // 第二步：检查是否有 [文字] 格式
                    if (startIndex > 0 && line[startIndex - 1] === ']') {
                        // 向前查找匹配的 '['
                        let bracketStart = -1;
                        for (let i = startIndex - 2; i >= 0; i--) {
                            if (line[i] === '[') {
                                bracketStart = i;
                                break;
                            }
                        }
                        
                        if (bracketStart >= 0) {
                            startIndex = bracketStart;
                        }
                    } else {
                        // 第三步：如果没有方括号，删除价格前的符号，但保留括号
                        while (startIndex > 0) {
                            // 检查是否是Emoji（需要处理代理对）
                            let charLength = 1;
                            let char = line[startIndex - 1];
                            
                            // 检查是否是高代理对（Emoji的第一个字符）
                            if (startIndex > 1) {
                                const prevChar = line[startIndex - 2];
                                const currentChar = line[startIndex - 1];
                                
                                // 检查是否是代理对（Emoji）
                                if (prevChar && currentChar) {
                                    const prevCode = prevChar.charCodeAt(0);
                                    const currentCode = currentChar.charCodeAt(0);
                                    
                                    // 高代理对范围：0xD800-0xDBFF，低代理对范围：0xDC00-0xDFFF
                                    if (prevCode >= 0xD800 && prevCode <= 0xDBFF && 
                                        currentCode >= 0xDC00 && currentCode <= 0xDFFF) {
                                        charLength = 2;
                                        char = line.substring(startIndex - 2, startIndex);
                                        startIndex -= 2; // 跳过两个字符
                                    } else {
                                        startIndex--;
                                    }
                                } else {
                                    startIndex--;
                                }
                            } else {
                                startIndex--;
                            }
                            
                            // 如果是字母、数字、中文，停止删除
                            if (/[A-Za-z0-9\u4e00-\u9fa5]/.test(char)) {
                                break;
                            }
                            
                            // 如果是括号（中文或英文），停止删除
                            if (char === ')' || char === '）') {
                                break;
                            }
                            
                            // 删除其他符号：价格符号、emoji、标点符号、斜杠等
                            const isPriceSymbol = /[¥$€£₹💰￥]/.test(char);
                            const isEmoji = isEmojiChar(char);
                            const isPunctuation = /[!@#$%^&*()_+=\[\]{}|;':",./<>?~`-]/.test(char);
                            const isSlash = char === '/';
                            
                            if (!isPriceSymbol && !isEmoji && !isPunctuation && !isSlash) {
                                break;
                            }
                        }
                    }
                    
                    const beforeSeparator = line.substring(0, startIndex);
                    const afterPrice = line.substring(priceIndex + priceStr.length);
                    return beforeSeparator + replaceSymbol + priceStr + afterPrice;
                }
                
                return line;
            }
            
            // 新增：更准确的Emoji检测函数
            function isEmojiChar(char) {
                if (!char) return false;
                
                // 处理代理对（Emoji）
                if (char.length === 2) {
                    const code1 = char.charCodeAt(0);
                    const code2 = char.charCodeAt(1);
                    
                    // 高代理对 + 低代理对 = Emoji
                    if (code1 >= 0xD800 && code1 <= 0xDBFF && 
                        code2 >= 0xDC00 && code2 <= 0xDFFF) {
                        return true;
                    }
                }
                
                // 处理单个字符的Emoji
                const codePoint = char.codePointAt(0);
                
                // Emoji Unicode 范围
                return (
                    // 表情符号和象形文字
                    (codePoint >= 0x1F300 && codePoint <= 0x1F5FF) || // 杂项符号和象形文字
                    (codePoint >= 0x1F600 && codePoint <= 0x1F64F) || // 表情符号
                    (codePoint >= 0x1F680 && codePoint <= 0x1F6FF) || // 交通和地图符号
                    (codePoint >= 0x1F700 && codePoint <= 0x1F77F) || // 炼金术符号
                    (codePoint >= 0x1F780 && codePoint <= 0x1F7FF) || // 几何形状扩展
                    (codePoint >= 0x1F800 && codePoint <= 0x1F8FF) || // 补充箭头-C
                    (codePoint >= 0x1F900 && codePoint <= 0x1F9FF) || // 补充符号和象形文字
                    (codePoint >= 0x1FA00 && codePoint <= 0x1FA6F) || // 象棋符号
                    (codePoint >= 0x1FA70 && codePoint <= 0x1FAFF) || // 符号和象形文字扩展-A
                    (codePoint >= 0x2600 && codePoint <= 0x26FF) ||   // 杂项符号
                    (codePoint >= 0x2700 && codePoint <= 0x27BF) ||   // 装饰符号
                    (codePoint >= 0xFE00 && codePoint <= 0xFE0F) ||  // 变体选择器
                    (codePoint >= 0x1F1E0 && codePoint <= 0x1F1FF)   // 区域指示符号
                );
            }
            
            function showCopySuccess() {
                const toast = document.createElement('div');
                toast.textContent = '✓ 已复制到剪贴板';
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 9999;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }
            
            function fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    showCopySuccess();
                } catch (err) {
                    alert('复制失败，请手动复制');
                }
                
                document.body.removeChild(textarea);
            }
            
            return {
                init: init,
                parseProducts: parseProducts,
                applyPriceSeparator: applyPriceSeparator,
                copyResults: copyResults
            };
        })();
        
        // ========== 会员系统 JavaScript ==========
        const Membership = (function() {
            let membershipData = {
                isMember: false,
                expiryDate: null,
                packageType: null,
                referralCode: null,
                referredBy: null
            };
            
            // 套餐配置
            const packages = {
                monthly: {
                    name: '月度会员',
                    price: 19,
                    originalPrice: 33,
                    days: 30,
                    isNewUser: true
                },
                halfyear: {
                    name: '半年会员',
                    price: 99,
                    originalPrice: 198,
                    days: 120,
                    isNewUser: false
                },
                yearly: {
                    name: '年度会员',
                    price: 188,
                    originalPrice: 396,
                    days: 360,
                    isNewUser: false
                }
            };
            
            function init() {
                loadMembershipData();
                generateReferralCode();
                updateMembershipStatus();
                checkMembershipExpiry();
            }
            
            function loadMembershipData() {
                const saved = localStorage.getItem('membership_data');
                if (saved) {
                    membershipData = JSON.parse(saved);
                }
            }
            
            function saveMembershipData() {
                localStorage.setItem('membership_data', JSON.stringify(membershipData));
            }
            
            function generateReferralCode() {
                if (!membershipData.referralCode) {
                    // 生成8位推荐码
                    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                    let result = '';
                    for (let i = 0; i < 8; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    membershipData.referralCode = result;
                    saveMembershipData();
                }
                document.getElementById('myReferralCode').value = membershipData.referralCode;
            }
            
            function updateMembershipStatus() {
                const statusCard = document.getElementById('membershipStatusCard');
                const statusText = document.getElementById('membershipStatus');
                const expiryText = document.getElementById('membershipExpiry');
                
                if (membershipData.isMember && membershipData.expiryDate) {
                    const expiryDate = new Date(membershipData.expiryDate);
                    const now = new Date();
                    
                    if (expiryDate > now) {
                        statusText.textContent = `👑 ${packages[membershipData.packageType]?.name || '会员'}`;
                        expiryText.textContent = `到期时间：${expiryDate.toLocaleDateString()}`;
                        statusCard.style.background = 'linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)';
                    } else {
                        // 会员已过期
                        membershipData.isMember = false;
                        membershipData.expiryDate = null;
                        membershipData.packageType = null;
                        saveMembershipData();
                        showMembershipExpired();
                    }
                } else {
                    statusText.textContent = '免费用户';
                    expiryText.textContent = '立即开通会员，享受更多功能';
                    statusCard.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }
            
            function showMembershipExpired() {
                const statusText = document.getElementById('membershipStatus');
                const expiryText = document.getElementById('membershipExpiry');
                statusText.textContent = '会员已过期';
                expiryText.textContent = '续费会员，继续享受特权';
            }
            
            function checkMembershipExpiry() {
                if (membershipData.isMember && membershipData.expiryDate) {
                    const expiryDate = new Date(membershipData.expiryDate);
                    const now = new Date();
                    const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysLeft <= 7 && daysLeft > 0) {
                        showExpiryWarning(daysLeft);
                    }
                }
            }
            
            function showExpiryWarning(daysLeft) {
                const message = `您的会员将在${daysLeft}天后到期，请及时续费！`;
                if (confirm(message)) {
                    showPurchaseModal();
                }
            }
            
            function showPurchaseModal() {
                // 1. 切换到会员Tab
                const tabItems = document.querySelectorAll('.tab-item');
                const tabContents = document.querySelectorAll('.tab-content');
                
                // 移除所有active类
                tabItems.forEach(tab => tab.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // 激活会员Tab
                const membershipTab = document.querySelector('[data-tab="membership"]');
                const membershipContent = document.getElementById('membership');
                if (membershipTab) membershipTab.classList.add('active');
                if (membershipContent) membershipContent.classList.add('active');
                
                // 2. 显示购买套餐区域并滚动到那里
                setTimeout(() => {
                    const packagesDiv = document.getElementById('membershipPackages');
                    if (packagesDiv) {
                        packagesDiv.style.display = 'block';
                        packagesDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100); // 短暂延迟确保Tab切换完成
            }
            
            function selectPackage(packageType) {
                const packageInfo = packages[packageType];
                if (!packageInfo) return;
                
                const confirmMessage = `确认购买${packageInfo.name}？\n价格：¥${packageInfo.price}（原价¥${packageInfo.originalPrice}）\n会员天数：${packageInfo.days}天`;
                
                if (confirm(confirmMessage)) {
                    processPurchase(packageType);
                }
            }
            
            function processPurchase(packageType) {
                const packageInfo = packages[packageType];
                const now = new Date();
                const expiryDate = new Date(now.getTime() + packageInfo.days * 24 * 60 * 60 * 1000);
                
                // 更新会员状态
                membershipData.isMember = true;
                membershipData.expiryDate = expiryDate.toISOString();
                membershipData.packageType = packageType;
                
                // 检查是否有推荐人奖励
                if (membershipData.referredBy) {
                    addReferralReward(membershipData.referredBy, packageType);
                }
                
                saveMembershipData();
                updateMembershipStatus();
                
                // 显示成功消息
                showSuccessMessage(`恭喜！您已成功开通${packageInfo.name}，享受${packageInfo.days}天会员权益！`);
                
                // 隐藏套餐选择
                document.getElementById('membershipPackages').style.display = 'none';
            }
            
            function addReferralReward(referrerCode, packageType) {
                // 推荐人获得20天奖励
                const referrerData = JSON.parse(localStorage.getItem(`referrer_${referrerCode}`) || '{}');
                const currentExpiry = referrerData.expiryDate ? new Date(referrerData.expiryDate) : new Date();
                const newExpiry = new Date(currentExpiry.getTime() + 20 * 24 * 60 * 60 * 1000);
                referrerData.expiryDate = newExpiry.toISOString();
                referrerData.referralCount = (referrerData.referralCount || 0) + 1;
                localStorage.setItem(`referrer_${referrerCode}`, JSON.stringify(referrerData));
                
                // 如果是首次购买，推荐人额外获得40天
                if (packageType !== 'monthly') {
                    const extraExpiry = new Date(newExpiry.getTime() + 40 * 24 * 60 * 60 * 1000);
                    referrerData.expiryDate = extraExpiry.toISOString();
                    localStorage.setItem(`referrer_${referrerCode}`, JSON.stringify(referrerData));
                }
            }
            
            function applyReferralCode() {
                const code = document.getElementById('referralCodeInput').value.trim();
                if (!code) {
                    alert('请输入推荐码');
                    return;
                }
                
                if (code === membershipData.referralCode) {
                    alert('不能使用自己的推荐码');
                    return;
                }
                
                // 检查推荐码是否存在
                const referrerData = JSON.parse(localStorage.getItem(`referrer_${code}`) || '{}');
                if (!referrerData.expiryDate || new Date(referrerData.expiryDate) <= new Date()) {
                    alert('推荐码无效或已过期');
                    return;
                }
                
                // 应用推荐码
                membershipData.referredBy = code;
                saveMembershipData();
                
                // 给双方添加奖励天数
                const now = new Date();
                
                // 被推荐人获得7天
                if (membershipData.isMember && membershipData.expiryDate) {
                    const currentExpiry = new Date(membershipData.expiryDate);
                    const newExpiry = new Date(Math.max(currentExpiry, now).getTime() + 7 * 24 * 60 * 60 * 1000);
                    membershipData.expiryDate = newExpiry.toISOString();
                } else {
                    const newExpiry = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                    membershipData.isMember = true;
                    membershipData.expiryDate = newExpiry.toISOString();
                    membershipData.packageType = 'referral';
                }
                
                // 推荐人获得20天
                const referrerExpiry = new Date(referrerData.expiryDate);
                const referrerNewExpiry = new Date(referrerExpiry.getTime() + 20 * 24 * 60 * 60 * 1000);
                referrerData.expiryDate = referrerNewExpiry.toISOString();
                referrerData.referralCount = (referrerData.referralCount || 0) + 1;
                localStorage.setItem(`referrer_${code}`, JSON.stringify(referrerData));
                
                saveMembershipData();
                updateMembershipStatus();
                
                showSuccessMessage('推荐码使用成功！您获得了7天会员权益，推荐人也获得了20天奖励！');
                document.getElementById('referralCodeInput').value = '';
            }
            
            function copyReferralCode() {
                const code = membershipData.referralCode;
                navigator.clipboard.writeText(code).then(() => {
                    showSuccessMessage('推荐码已复制到剪贴板！');
                }).catch(() => {
                    // 降级方案
                    const input = document.getElementById('myReferralCode');
                    input.select();
                    document.execCommand('copy');
                    showSuccessMessage('推荐码已复制到剪贴板！');
                });
            }
            
            function showSuccessMessage(message) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            function isMember() {
                // 测试阶段：临时返回true，启用所有会员功能
                return true;
                
                // 原始代码（已注释）：
                // return membershipData.isMember && 
                //        membershipData.expiryDate && 
                //        new Date(membershipData.expiryDate) > new Date();
            }
            
            function getMemberDaysLeft() {
                if (!isMember()) return 0;
                const expiryDate = new Date(membershipData.expiryDate);
                const now = new Date();
                return Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            }
            
            return {
                init: init,
                isMember: isMember,
                getMemberDaysLeft: getMemberDaysLeft,
                showPurchaseModal: showPurchaseModal,
                selectPackage: selectPackage,
                applyReferralCode: applyReferralCode,
                copyReferralCode: copyReferralCode
            };
        })();
        
        // ========== 设置系统 JavaScript ==========
        const Settings = (function() {
            let userData = {
                isLoggedIn: false,
                username: null,
                email: null,
                loginTime: null
            };
            
            let settingsData = {
                theme: 'light',
                fontSize: 'medium',
                autoSave: true,
                priceHint: true,
                vibration: false
            };
            
            function init() {
                loadUserData();
                loadSettings();
                updateUserInfo();
                applySettings();
                bindEvents();
                checkLoginStatus(); // 检查登录状态
            }
            
            function loadUserData() {
                const saved = localStorage.getItem('user_data');
                if (saved) {
                    userData = JSON.parse(saved);
                }
            }
            
            function saveUserData() {
                localStorage.setItem('user_data', JSON.stringify(userData));
            }
            
            function loadSettings() {
                const saved = localStorage.getItem('settings_data');
                if (saved) {
                    settingsData = JSON.parse(saved);
                }
                updateSettingsUI();
            }
            
            function saveSettings() {
                localStorage.setItem('settings_data', JSON.stringify(settingsData));
            }
            
            function updateSettingsUI() {
                document.getElementById('themeSelect').value = settingsData.theme;
                document.getElementById('fontSizeSelect').value = settingsData.fontSize;
                document.getElementById('autoSave').checked = settingsData.autoSave;
                document.getElementById('priceHint').checked = settingsData.priceHint;
                document.getElementById('vibration').checked = settingsData.vibration;
            }
            
            function updateUserInfo() {
                const userName = document.getElementById('userName');
                const userStatus = document.getElementById('userStatus');
                const loginBtn = document.getElementById('loginBtn');
                
                if (userData.isLoggedIn) {
                    userName.textContent = userData.username;
                    userStatus.textContent = `登录时间：${new Date(userData.loginTime).toLocaleString()}`;
                    loginBtn.textContent = '退出';
                    loginBtn.onclick = logout;
                } else {
                    userName.textContent = '未登录';
                    userStatus.textContent = '点击登录享受更多功能';
                    loginBtn.textContent = '登录';
                    loginBtn.onclick = showLoginModal;
                }
            }
            
            function bindEvents() {
                // 登录表单
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                
                // 注册表单
                document.getElementById('registerForm').addEventListener('submit', handleRegister);
                
                // 模态框点击外部关闭
                window.addEventListener('click', function(event) {
                    const loginModal = document.getElementById('loginModal');
                    const registerModal = document.getElementById('registerModal');
                    const helpModal = document.getElementById('helpModal');
                    
                    if (event.target === loginModal) {
                        closeLoginModal();
                    }
                    if (event.target === registerModal) {
                        closeRegisterModal();
                    }
                    if (helpModal && event.target === helpModal) {
                        closeHelpModal();
                    }
                });
            }
            
            function showLoginModal() {
                document.getElementById('loginModal').style.display = 'block';
            }
            
            function closeLoginModal() {
                document.getElementById('loginModal').style.display = 'none';
            }
            
            function showRegisterModal() {
                closeLoginModal();
                document.getElementById('registerModal').style.display = 'block';
            }
            
            function closeRegisterModal() {
                document.getElementById('registerModal').style.display = 'none';
            }
            
            function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                // 简单的模拟登录验证
                if (username && password) {
                    userData.isLoggedIn = true;
                    userData.username = username;
                    userData.loginTime = new Date().toISOString();
                    
                    if (rememberMe) {
                        saveUserData();
                    }
                    
                    updateUserInfo();
                    closeLoginModal();
                    showSuccessMessage('登录成功！');
                    
                    // 清空表单
                    document.getElementById('loginForm').reset();
                } else {
                    alert('请输入用户名和密码');
                }
            }
            
            function handleRegister(e) {
                e.preventDefault();
                const username = document.getElementById('regUsername').value;
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const email = document.getElementById('regEmail').value;
                
                if (password !== confirmPassword) {
                    alert('两次输入的密码不一致');
                    return;
                }
                
                if (username && password) {
                    // 模拟注册成功
                    showSuccessMessage('注册成功！请登录');
                    closeRegisterModal();
                    showLoginModal();
                    
                    // 清空表单
                    document.getElementById('registerForm').reset();
                } else {
                    alert('请填写必要信息');
                }
            }
            
            function logout() {
                userData.isLoggedIn = false;
                userData.username = null;
                userData.email = null;
                userData.loginTime = null;
                
                localStorage.removeItem('user_data');
                updateUserInfo();
                showSuccessMessage('已退出登录');
            }
            
            function changeTheme() {
                const theme = document.getElementById('themeSelect').value;
                settingsData.theme = theme;
                saveSettings();
                applyTheme(theme);
            }
            
            function applyTheme(theme) {
                const body = document.body;
                body.className = body.className.replace(/theme-\w+/g, '');
                
                if (theme === 'dark') {
                    body.classList.add('theme-dark');
                } else if (theme === 'auto') {
                    // 跟随系统主题
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        body.classList.add('theme-dark');
                    }
                }
            }
            
            function changeFontSize() {
                const fontSize = document.getElementById('fontSizeSelect').value;
                settingsData.fontSize = fontSize;
                saveSettings();
                applyFontSize(fontSize);
            }
            
            function applyFontSize(size) {
                const body = document.body;
                body.className = body.className.replace(/font-\w+/g, '');
                body.classList.add(`font-${size}`);
            }
            
            function toggleAutoSave() {
                settingsData.autoSave = document.getElementById('autoSave').checked;
                saveSettings();
            }
            
            function togglePriceHint() {
                settingsData.priceHint = document.getElementById('priceHint').checked;
                saveSettings();
            }
            
            function toggleVibration() {
                settingsData.vibration = document.getElementById('vibration').checked;
                saveSettings();
            }
            
            function applySettings() {
                applyTheme(settingsData.theme);
                applyFontSize(settingsData.fontSize);
            }
            
            function exportData() {
                const allData = {
                    userData: userData,
                    settingsData: settingsData,
                    membershipData: JSON.parse(localStorage.getItem('membership_data') || '{}'),
                    productManagerData: JSON.parse(localStorage.getItem('productManager_data') || '{}'),
                    priceAdjusterData: JSON.parse(localStorage.getItem('priceAdjuster_data') || '{}'),
                    symbolChangerData: JSON.parse(localStorage.getItem('symbolChanger_data') || '{}')
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `家电报价助手_数据备份_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccessMessage('数据导出成功！');
            }
            
            function importData() {
                const file = document.getElementById('importFile').files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 恢复各种数据
                        if (data.userData) {
                            localStorage.setItem('user_data', JSON.stringify(data.userData));
                            userData = data.userData;
                        }
                        if (data.settingsData) {
                            localStorage.setItem('settings_data', JSON.stringify(data.settingsData));
                            settingsData = data.settingsData;
                        }
                        if (data.membershipData) {
                            localStorage.setItem('membership_data', JSON.stringify(data.membershipData));
                        }
                        if (data.productManagerData) {
                            localStorage.setItem('productManager_data', JSON.stringify(data.productManagerData));
                        }
                        if (data.priceAdjusterData) {
                            localStorage.setItem('priceAdjuster_data', JSON.stringify(data.priceAdjusterData));
                        }
                        if (data.symbolChangerData) {
                            localStorage.setItem('symbolChanger_data', JSON.stringify(data.symbolChangerData));
                        }
                        
                        // 更新界面
                        updateUserInfo();
                        updateSettingsUI();
                        applySettings();
                        
                        showSuccessMessage('数据导入成功！');
                    } catch (error) {
                        alert('文件格式错误，请选择正确的备份文件');
                    }
                };
                reader.readAsText(file);
            }
            
            function clearData() {
                if (confirm('确定要清除所有数据吗？此操作不可恢复！')) {
                    localStorage.clear();
                    location.reload();
                }
            }
            
            function showFeedback() {
                alert('意见反馈功能开发中，敬请期待！');
            }
            
            // 一键登录处理
            function handlePhoneLogin() {
                console.log('一键登录被点击');
                console.log('ALIYUN_CONFIG:', ALIYUN_CONFIG);
                console.log('PhoneNumberServer是否加载:', typeof PhoneNumberServer);
                console.log('window.PhoneNumberServer:', typeof window.PhoneNumberServer);
                console.log('所有window属性:', Object.keys(window).filter(key => key.includes('Phone') || key.includes('Aliyun')));
                
                // 先显示一个明显的提示
                alert('一键登录被点击！\n\n正在检查SDK状态...\n\nPhoneNumberServer: ' + (typeof PhoneNumberServer) + '\nwindow.PhoneNumberServer: ' + (typeof window.PhoneNumberServer));
                
                // 检查SDK是否加载成功
                if (typeof PhoneNumberServer === 'undefined' && typeof window.PhoneNumberServer === 'undefined') {
                    console.log('阿里云SDK未加载，回退到开发模式');
                    alert('阿里云SDK未加载，切换到模拟模式');
                    showPhoneLoginModal();
                    return;
                }
                
                if (ALIYUN_CONFIG.isDevelopment) {
                    // 开发模式：使用模拟数据
                    console.log('使用开发模式');
                    alert('当前为开发模式');
                    showPhoneLoginModal();
                } else {
                    // 生产模式：调用阿里云 SDK
                    console.log('使用生产模式');
                    alert('当前为生产模式，准备调用阿里云SDK');
                    callAliyunPhoneAuth();
                }
            }
            
            // 显示手机号登录模态框（开发模式）
            function showPhoneLoginModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2>📱 一键登录</h2>
                            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
                                <h3 style="margin: 0 0 8px 0;">阿里云审核中</h3>
                                <p style="color: #666; margin: 0 0 20px 0;">您的号码认证方案正在阿里云审核中，预计1-2个工作日生效</p>
                                <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                                    <p style="margin: 0; font-size: 14px; color: #856404;">
                                        <strong>当前状态：</strong>审核中<br>
                                        <strong>方案 Code：</strong>${ALIYUN_CONFIG.sceneCode}<br>
                                        <strong>预计生效：</strong>1-2个工作日
                                    </p>
                                </div>
                                <div style="background: #f0f8ff; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                    <p style="margin: 0; font-size: 14px; color: #333;">
                                        <strong>临时测试：</strong>使用模拟登录功能
                                    </p>
                                </div>
                                <button class="btn btn-primary" onclick="Settings.simulatePhoneLogin()" style="width: 100%;">
                                    模拟登录测试
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // 模拟手机号登录
            function simulatePhoneLogin() {
                // 模拟调用后端验证接口
                const mockToken = 'mock_token_' + Date.now();
                
                fetch('/.netlify/functions/auth/verify-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: mockToken })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 保存 JWT 和用户信息
                        localStorage.setItem('jwt', data.jwt);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        // 更新 UI
                        updateUserInfo(data.user);
                        
                        // 关闭模态框
                        document.querySelector('.modal').remove();
                        
                        showSuccessMessage('登录成功！');
                    } else {
                        alert('登录失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    alert('登录失败，请稍后重试');
                });
            }
            
            // 调用阿里云号码认证 SDK（生产模式）
            function callAliyunPhoneAuth() {
                if (typeof PhoneNumberServer === 'undefined') {
                    alert('阿里云SDK加载失败，请刷新页面重试');
                    return;
                }
                
                const phoneNumberServer = new PhoneNumberServer();
                
                // 第一步：获取accessToken和jwtToken
                getAuthTokens()
                    .then(({ accessToken, jwtToken }) => {
                        // 第二步：身份鉴权
                        phoneNumberServer.checkLoginAvailable({
                            accessToken: accessToken,
                            jwtToken: jwtToken,
                            success: function (res) {
                                console.log('鉴权成功', res);
                                if (res.code === 600000) {
                                    // 第三步：获取登录Token
                                    getLoginToken(phoneNumberServer);
                                } else {
                                    alert('鉴权失败：' + (res.message || '未知错误'));
                                }
                            },
                            error: function (res) {
                                console.log('鉴权失败', res);
                                alert('鉴权失败，请关闭WiFi使用移动网络重试');
                            }
                        });
                    })
                    .catch(error => {
                        console.error('获取Token失败:', error);
                        alert('获取认证Token失败：' + error.message);
                    });
            }
            
            // 获取认证Token
            function getAuthTokens() {
                console.log('开始获取认证Token...');
                
                // 先测试简单函数
                return fetch('/.netlify/functions/auth/simple-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ test: 'data' })
                })
                .then(response => {
                    console.log('simple-test响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('simple-test响应结果:', data);
                    
                    // 现在测试真实函数
                    return fetch('/.netlify/functions/auth/get-auth-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ sceneCode: ALIYUN_CONFIG.sceneCode })
                    });
                })
                .then(response => {
                    console.log('get-auth-token响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('get-auth-token响应结果:', data);
                    if (data.success) {
                        return { accessToken: data.accessToken, jwtToken: data.jwtToken };
                    } else {
                        throw new Error(data.message || '获取Token失败');
                    }
                });
            }
            
            // 获取登录Token
            function getLoginToken(phoneNumberServer) {
                phoneNumberServer.getLoginToken({
                    success: function (res) {
                        console.log('获取登录Token成功', res);
                        // 第四步：服务端取号
                        getPhoneNumber(res.spToken);
                    },
                    error: function (res) {
                        console.log('获取登录Token失败', res);
                        alert('获取登录Token失败：' + (res.message || '未知错误'));
                    },
                    watch: function (status, data) {
                        console.log('授权页状态:', status, data);
                    }
                });
            }
            
            // 服务端取号
            function getPhoneNumber(spToken) {
                fetch('/.netlify/functions/auth/verify-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ spToken: spToken })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.setItem('jwt', data.jwt);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        updateUserInfo(data.user);
                        showSuccessMessage('登录成功！');
                    } else {
                        alert('登录失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    alert('登录失败，请稍后重试');
                });
            }
            
            // 更新用户信息显示
            function updateUserInfo(user) {
                const userName = document.getElementById('userName');
                const userStatus = document.getElementById('userStatus');
                const loginButtons = document.getElementById('loginButtons');
                
                if (user) {
                    userName.textContent = user.phone || '已登录';
                    userStatus.textContent = user.isMember ? 
                        `会员用户 | 到期：${new Date(user.memberExpireAt).toLocaleDateString()}` : 
                        '免费用户';
                    
                    loginButtons.innerHTML = `
                        <button class="btn btn-danger" onclick="Settings.logout()">退出登录</button>
                    `;
                } else {
                    userName.textContent = '未登录';
                    userStatus.textContent = '点击登录享受更多功能';
                    loginButtons.innerHTML = `
                        <button class="btn btn-primary" onclick="Settings.handlePhoneLogin()" id="phoneLoginBtn">📱 一键登录</button>
                        <button class="btn btn-secondary" onclick="Settings.showLoginModal()" id="otherLoginBtn">其他登录</button>
                    `;
                }
            }
            
            // 退出登录
            function logout() {
                localStorage.removeItem('jwt');
                localStorage.removeItem('user');
                updateUserInfo(null);
                showSuccessMessage('已退出登录');
            }
            
            // 检查登录状态
            function checkLoginStatus() {
                const jwt = localStorage.getItem('jwt');
                const user = localStorage.getItem('user');
                
                if (jwt && user) {
                    try {
                        const userData = JSON.parse(user);
                        updateUserInfo(userData);
                    } catch (error) {
                        console.error('Parse user data error:', error);
                        logout();
                    }
                }
            }

            function showHelp() {
                let helpModal = document.getElementById('helpModal');
                if (!helpModal) {
                    helpModal = document.createElement('div');
                    helpModal.id = 'helpModal';
                    helpModal.className = 'modal';
                    helpModal.innerHTML = `
                        <div class="modal-content" style="max-width: 520px; width: 92%;">
                            <div class="modal-header">
                                <h2>使用帮助</h2>
                                <span class="close" onclick="Settings.closeHelpModal()">&times;</span>
                            </div>
                            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                <div style="display: grid; gap: 16px;">
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">📌 导航与切换</h3>
                                        <p style="margin:0; color:#555; font-size:14px;">顶部标签栏在 <strong>产品管理 / 价格调整 / 符号更换 / 会员 / 设置</strong> 之间切换。</p>
                                    </div>
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">🗂 产品管理</h3>
                                        <ul style="margin:0; padding-left:18px; color:#555; font-size:14px;">
                                            <li>粘贴文本后点"解析文本"。</li>
                                            <li>点每行可直接编辑；支持排序与批量删除。</li>
                                            <li>"复制结果"按当前排序输出，保持段落顺序。</li>
                                        </ul>
                                    </div>
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">💰 价格调整</h3>
                                        <ul style="margin:0; padding-left:18px; color:#555; font-size:14px;">
                                            <li>支持百分比/固定额调价，默认 <strong>+5%</strong>，并可四舍五入到十位。</li>
                                            <li>可开启区间调价：0-999、1000-1999、2000-4999、5000-9999、10000+。</li>
                                            <li>颜色提示：紫-手动、红-上涨、绿-下降。</li>
                                        </ul>
                                    </div>
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">🔄 符号更换</h3>
                                        <ul style="margin:0; padding-left:18px; color:#555; font-size:14px;">
                                            <li>批量替换价格前符号（如 💰、【发】）。</li>
                                            <li>勾选"结尾说明"后，内容仅追加到整篇末尾一次。</li>
                                        </ul>
                                    </div>
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">👑 会员与推荐</h3>
                                        <ul style="margin:0; padding-left:18px; color:#555; font-size:14px;">
                                            <li>套餐：月/半年/年，购买后解锁无限制与优先支持。</li>
                                            <li>推荐码：A 获 20 天，B 获 7 天；B 首购，A 再加 40 天。</li>
                                        </ul>
                                    </div>
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">⚙️ 设置与数据</h3>
                                        <ul style="margin:0; padding-left:18px; color:#555; font-size:14px;">
                                            <li>主题：浅色/深色/跟随系统；字体：小/中/大。</li>
                                            <li>数据：导入/导出备份，一键清除重置。</li>
                                            <li>登录：支持记住我与自动登录。</li>
                                        </ul>
                                    </div>
                                    <div style="background:#f8f9fa; border-radius:10px; padding:12px;">
                                        <h3 style="margin:0 0 8px 0; font-size:16px;">📲 安装为手机APP</h3>
                                        <ul style="margin:0; padding-left:18px; color:#555; font-size:14px;">
                                            <li>Edge/Chrome 打开站点 → 菜单 → 添加到主屏（安装）。</li>
                                            <li>更新：下拉刷新或重新打开即可获取最新版。</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(helpModal);
                }
                helpModal.style.display = 'block';
            }

            function closeHelpModal() {
                const helpModal = document.getElementById('helpModal');
                if (helpModal) helpModal.style.display = 'none';
            }
            
            function showSuccessMessage(message) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            return {
                init: init,
                showLoginModal: showLoginModal,
                closeLoginModal: closeLoginModal,
                showRegisterModal: showRegisterModal,
                closeRegisterModal: closeRegisterModal,
                changeTheme: changeTheme,
                changeFontSize: changeFontSize,
                toggleAutoSave: toggleAutoSave,
                togglePriceHint: togglePriceHint,
                toggleVibration: toggleVibration,
                exportData: exportData,
                importData: importData,
                clearData: clearData,
                showFeedback: showFeedback,
                showHelp: showHelp,
                closeHelpModal: closeHelpModal,
                handlePhoneLogin: handlePhoneLogin,
                simulatePhoneLogin: simulatePhoneLogin,
                logout: logout
            };
        })();
        
        // ========== 历史记录管理器 ==========
        const HistoryManager = (function() {
            let historyRecords = [];
            let isCompareMode = false;
            let selectedRecords = [];
            
            function init() {
                loadRecords();
                populateYearOptions();
                // 统一监听历史更新事件，收到后立即刷新视图与日历
                window.addEventListener('history:updated', function() {
                    renderCalendar();
                    renderRecords();
                });
            }
            
            function loadRecords() {
                const saved = localStorage.getItem('historyRecords');
                if (saved) {
                    historyRecords = JSON.parse(saved);
                }
            }
            
            function saveRecords() {
                localStorage.setItem('historyRecords', JSON.stringify(historyRecords));
            }
            
            function populateYearOptions() {
                const yearSelect = document.getElementById('historyYearSelect');
                if (!yearSelect) return;
                
                const currentYear = new Date().getFullYear();
                const years = [currentYear];
                historyRecords.forEach(record => {
                    const recordYear = new Date(record.timestamp).getFullYear();
                    if (!years.includes(recordYear)) {
                        years.push(recordYear);
                    }
                });
                years.sort((a, b) => b - a);
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + '年';
                    yearSelect.appendChild(option);
                });
            }
            
            function saveRecord(source, title) {
                // 默认来源为产品管理
                if (!source) source = 'productManager';
                
                // 根据来源确定截图目标容器
                let container, products = [];
                
                if (source === 'productManager') {
                    container = document.getElementById('pm_resultsContainer');
                    if (!container || container.children.length === 0) {
                        alert('请先解析并获取产品列表');
                        return;
                    }
                    
                    // 提取产品信息（与“复制结果”一致，读取 .item-text；无价格也保存）
                    container.querySelectorAll('.result-item').forEach(item => {
                        const textEl = item.querySelector('.item-text');
                        const fallbackEl = item.querySelector('.result-text');
                        const text = (textEl ? textEl.textContent : (fallbackEl ? fallbackEl.textContent : item.textContent)).trim();
                        const prices = findExplicitPrices(text);
                        products.push({
                            text: text,
                            price: prices.length > 0 ? prices[0] : ''
                        });
                    });
                } else if (source === 'priceAdjuster') {
                    container = document.getElementById('pa_resultArea');
                    if (!container || container.children.length === 0) {
                        alert('请先解析并获取调价结果');
                        return;
                    }
                    
                    // 提取调价数据（以 PriceAdjuster.displayResults 生成的结构为准）
                    container.querySelectorAll('.result-item').forEach(item => {
                        const contentEl = item.querySelector('.result-content');
                        const originalPriceEl = item.querySelector('.result-price.original');
                        const newPriceEl = item.querySelector('.result-price.new');
                        const textContent = (contentEl ? contentEl.textContent : '').trim();
                        if (!textContent) return;
                        if (originalPriceEl && newPriceEl) {
                            products.push({
                                text: textContent,
                                originalPrice: originalPriceEl.textContent.replace('¥', '').replace(/,/g, ''),
                                newPrice: newPriceEl.textContent.replace('¥', '').replace(/,/g, '')
                            });
                        } else {
                            // 无价格的纯文本行也保存
                            products.push({ text: textContent });
                        }
                    });
                } else if (source === 'symbolChanger') {
                    container = document.getElementById('sc_resultArea');
                    if (!container || container.children.length === 0) {
                        alert('请先解析并获取符号更换结果');
                        return;
                    }
                    
                    // 提取符号更换后的数据：按“复制结果”的规则组合
                    container.querySelectorAll('.result-item').forEach(item => {
                        const contentEl = item.querySelector('.result-content');
                        const priceEl = item.querySelector('.result-price');
                        let line = (contentEl ? contentEl.textContent : item.textContent).trim();
                        if (priceEl && priceEl.textContent.trim()) {
                            const raw = priceEl.textContent.trim();
                            const numMatch = raw.match(/\d[\d.,]*/);
                            const num = numMatch ? numMatch[0].replace(/,/g, '') : '';
                            const sym = raw.replace(/[\d.,]/g, '');
                            if (num) {
                                const idx = line.lastIndexOf(num);
                                if (idx >= 0) {
                                    let start = idx;
                                    while (start > 0 && /[\s¥$€£₹💰￥!@#$%^&*()_+\-=/\\`~\[\]{}|;:'",.<>?]/.test(line[start-1])) {
                                        start--;
                                    }
                                    line = line.substring(0, start) + sym + line.substring(start);
                                }
                            }
                        }
                        products.push({ text: line });
                    });
                } else {
                    alert('未知的记录来源');
                    return;
                }
                
                const now = new Date();
                const timestamp = now.getTime();
                
                // 提取前两行作为预览文本
                let previewLines = [];
                if (products.length > 0) {
                    const firstTwo = products.slice(0, 2);
                    previewLines = firstTwo.map(p => {
                        // 限制每行长度，移动端约25-30个字符，桌面端可更长
                        let text = p.text || '';
                        // 移除前后空白
                        text = text.trim();
                        // 限制长度，避免过长（约30-35个中文字符）
                        if (text.length > 35) {
                            text = text.substring(0, 35) + '...';
                        }
                        return text;
                    }).filter(line => line.length > 0); // 过滤空行
                }
                
                // 直接保存文本信息，不使用截图
                const record = {
                    id: 'record_' + timestamp,
                    timestamp: timestamp,
                    date: now.toLocaleString('zh-CN'),
                    title: title || `历史记录 - ${now.toLocaleDateString('zh-CN')}`,
                    thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7liJvlu7rogIU8L3RleHQ+PC9zdmc+',
                    source: source, // 添加来源字段
                    productCount: products.length,
                    products: products,
                    previewText: previewLines // 添加预览文本字段
                };
                
                historyRecords.unshift(record); // 最新记录放在最前面
                saveRecords();
                // 立即刷新日历与列表，不等待
                renderCalendar();
                renderRecords();
                // 广播一次全局事件，供其他地方订阅
                try {
                    window.dispatchEvent(new CustomEvent('history:updated'));
                } catch (e) {}
                
                // 使用全局通知系统
                if (typeof showSuccessMessage === 'function') {
                    showSuccessMessage('历史记录已保存！');
                } else {
                    alert('历史记录已保存！');
                }
            }
            
            function showSaveDialog(source) {
                const title = prompt('请输入历史记录标题（留空将使用默认标题）：');
                if (title === null) return; // 用户取消
                saveRecord(source, title || undefined);
            }
            
            function deleteRecord(recordId) {
                if (confirm('确定要删除这条历史记录吗？')) {
                    historyRecords = historyRecords.filter(r => r.id !== recordId);
                    saveRecords();
                    renderRecords();
                }
            }
            
            function viewRecord(recordId) {
                const record = historyRecords.find(r => r.id === recordId);
                if (!record) return;
                
                // 根据来源切换到相应界面
                const source = record.source || 'productManager';
                let targetTab = 'productManager';
                let targetContainer = 'pm_resultsContainer';
                
                if (source === 'priceAdjuster') {
                    targetTab = 'priceAdjuster';
                    targetContainer = 'pa_resultArea';
                } else if (source === 'symbolChanger') {
                    targetTab = 'symbolChanger';
                    targetContainer = 'sc_resultArea';
                }
                
                // 切换到对应界面
                switchTab(targetTab);
                
                setTimeout(() => {
                    const container = document.getElementById(targetContainer);
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    if (source === 'productManager') {
                        // 产品管理界面
                        record.products.forEach((item, index) => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.innerHTML = `
                                <input type="checkbox" class="result-checkbox" onchange="ProductManager.toggleSelectAll()">
                                <div class="result-text" contenteditable="true">${item.text}</div>
                            `;
                            container.appendChild(div);
                        });
                    } else if (source === 'priceAdjuster') {
                        // 价格调整界面（文本 + 新价；无价则仅文本）
                        record.products.forEach((item, index) => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            const hasNewPrice = typeof item.newPrice !== 'undefined' && item.newPrice !== null && item.newPrice !== '';
                            const priceHtml = hasNewPrice ? `<div class=\\"result-price\\"><span class=\\"result-price new\\">¥${item.newPrice}</span></div>` : `<div class=\\"result-price\\"></div>`;
                            div.innerHTML = `
                                <div class=\"result-content\">${item.text}</div>
                                ${priceHtml}
                            `;
                            container.appendChild(div);
                        });
                    } else if (source === 'symbolChanger') {
                        // 符号更换界面
                        record.products.forEach((item, index) => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.innerHTML = `
                                <div class="result-text">${item.text}</div>
                            `;
                            container.appendChild(div);
                        });
                    }
                    
                    // 使用全局通知系统
                    if (typeof showSuccessMessage === 'function') {
                        showSuccessMessage('历史记录已加载！');
                    } else {
                        alert('历史记录已加载！');
                    }
                }, 300);
            }
            
            function showImage(recordId) {
                const record = historyRecords.find(r => r.id === recordId);
                if (!record) return;
                
                const modal = document.createElement('div');
                modal.className = 'image-viewer-modal';
                modal.innerHTML = `
                    <button class="image-viewer-close" onclick="this.parentElement.remove()">&times;</button>
                    <img src="${record.thumbnail}" class="image-viewer-img" id="viewerImg">
                `;
                
                document.body.appendChild(modal);
                
                // 简单的图片缩放支持
                const img = modal.querySelector('#viewerImg');
                let scale = 1;
                let startDistance = 0;
                
                modal.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        startDistance = Math.hypot(
                            touch1.clientX - touch2.clientX,
                            touch1.clientY - touch2.clientY
                        );
                    }
                });
                
                modal.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const distance = Math.hypot(
                            touch1.clientX - touch2.clientX,
                            touch1.clientY - touch2.clientY
                        );
                        
                        scale = distance / startDistance;
                        img.style.transform = `scale(${scale})`;
                    }
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            function enterCompareMode() {
                isCompareMode = true;
                selectedRecords = [];
                document.getElementById('compareFloatingBtn').style.display = 'none';
                renderRecords();
            }
            
            function exitCompareMode() {
                isCompareMode = false;
                selectedRecords = [];
                document.getElementById('compareFloatingBtn').style.display = 'none';
                renderRecords();
            }
            
            function toggleRecordSelection(recordId) {
                if (!isCompareMode) return;
                
                const index = selectedRecords.indexOf(recordId);
                if (index > -1) {
                    selectedRecords.splice(index, 1);
                } else {
                    if (selectedRecords.length < 3) {
                        selectedRecords.push(recordId);
                    } else {
                        alert('最多只能选择3条记录进行对比');
                    }
                }
                
                document.getElementById('compareCount').textContent = selectedRecords.length;
                document.getElementById('compareFloatingBtn').style.display = selectedRecords.length > 0 ? 'block' : 'none';
                
                renderRecords();
            }
            
            function startCompare() {
                if (selectedRecords.length < 2) {
                    alert('请至少选择2条记录进行对比');
                    return;
                }
                
                // 创建对比页面
                const compareView = document.createElement('div');
                compareView.id = 'compareView';
                compareView.style.cssText = `
                    position: fixed;
                    top: 50px;
                    left: 0;
                    right: 0;
                    bottom: 70px;
                    background: white;
                    z-index: 2000;
                    overflow-y: auto;
                    padding: 20px;
                `;
                
                const selected = historyRecords.filter(r => selectedRecords.includes(r.id));
                
                // 提取所有产品进行对比
                const productMap = {};
                selected.forEach((record, index) => {
                    record.products.forEach(product => {
                        const key = product.text.split('：')[0]; // 用产品名称作为键
                        if (!productMap[key]) {
                            productMap[key] = {};
                        }
                        productMap[key][`record_${index}`] = {
                            text: product.text,
                            price: product.price
                        };
                    });
                });
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <button onclick="document.getElementById('compareView').remove(); HistoryManager.exitCompareMode()" 
                                style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 20px;">
                            ← 返回</button>
                        <h2 style="margin: 20px 0;">价格对比分析</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${selected.map((r, i) => `
                                <div style="background: #f0f8ff; padding: 10px; border-radius: 6px;">
                                    <div><strong>记录${i+1}</strong></div>
                                    <div style="font-size: 12px; color: #666;">${r.date}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">产品名称</th>
                                ${selected.map((_, i) => `<th style="padding: 12px; text-align: center; border: 1px solid #ddd;">记录${i+1}价格</th>`).join('')}
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">变化趋势</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.keys(productMap).forEach((key, i) => {
                    const product = productMap[key];
                    const prices = selected.map((_, index) => product['record_' + index]);
                    
                    const bgColor = i % 2 === 0 ? '#fff' : '#fafafa';
                    
                    html += '<tr>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; background: ' + bgColor + ';">' + key + '</td>';
                    
                    prices.forEach((p) => {
                        const price = p ? p.price : '-';
                        html += '<td style="padding: 12px; text-align: center; border: 1px solid #ddd; background: ' + bgColor + ';">' + price + '</td>';
                    });
                    
                    // 价格变化趋势
                    const validPrices = prices.filter(function(p) { return p && p.price; }).map(function(p) {
                        return parseFloat(p.price.replace(/,/g, ''));
                    });
                    if (validPrices.length >= 2) {
                        const first = validPrices[0];
                        const last = validPrices[validPrices.length - 1];
                        const change = last - first;
                        const percent = ((change / first) * 100).toFixed(1);
                        const trend = change > 0 ? '↑' : change < 0 ? '↓' : '→';
                        const color = change > 0 ? '#e74c3c' : change < 0 ? '#27ae60' : '#999';
                        
                        html += '<td style="padding: 12px; text-align: center; border: 1px solid #ddd; color: ' + color + '; background: ' + bgColor + ';">';
                        html += trend + ' ' + percent + '%';
                        html += '</td>';
                    } else {
                        html += '<td style="padding: 12px; text-align: center; border: 1px solid #ddd;"></td>';
                    }
                    
                    html += '</tr>';
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                compareView.innerHTML = html;
                document.body.appendChild(compareView);
            }
            
            function filterRecords() {
                const year = document.getElementById('historyYearSelect').value;
                const month = document.getElementById('historyMonthSelect').value;
                
                let filtered = historyRecords;
                
                // 首先应用来源筛选
                if (currentFilterSource !== 'all') {
                    filtered = filtered.filter(r => (r.source || 'productManager') === currentFilterSource);
                }
                
                if (year !== 'all') {
                    filtered = filtered.filter(r => {
                        const recordYear = new Date(r.timestamp).getFullYear();
                        return recordYear.toString() === year;
                    });
                }
                
                if (month !== 'all') {
                    filtered = filtered.filter(r => {
                        const recordMonth = new Date(r.timestamp).getMonth() + 1;
                        return recordMonth.toString() === month;
                    });
                }
                
                // 显示筛选结果
                const container = document.getElementById('historyListContainer');
                container.innerHTML = '';
                
                if (filtered.length === 0) {
                    document.getElementById('historyEmptyState').style.display = 'block';
                    return;
                }
                
                document.getElementById('historyEmptyState').style.display = 'none';
                
                filtered.forEach(record => {
                    const card = document.createElement('div');
                    card.className = 'history-card';
                    card.style.position = 'relative';
                    
                    card.innerHTML = `
                        <img src="${record.thumbnail}" class="history-card-thumbnail" onclick="HistoryManager.showImage('${record.id}')">
                        <div class="history-card-title">${record.title}</div>
                        <div class="history-card-date">${record.date}</div>
                        <div class="history-card-info">
                            <span>产品数: ${record.productCount}</span>
                        </div>
                        <div class="history-card-actions">
                            <button class="btn btn-secondary" onclick="HistoryManager.viewRecord('${record.id}')">查看</button>
                            <button class="btn btn-danger" onclick="HistoryManager.deleteRecord('${record.id}')">删除</button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            function clearFilter() {
                document.getElementById('historyYearSelect').value = 'all';
                document.getElementById('historyMonthSelect').value = 'all';
                renderRecords();
            }
            
            function deleteAll() {
                if (confirm('确定要清空所有历史记录吗？此操作不可恢复！')) {
                    historyRecords = [];
                    saveRecords();
                    renderRecords();
                }
            }
            
            function findExplicitPrices(text) {
                // 简化版价格提取，从 ProductManager 复制
                const pricePattern = /(\d{1,3}(?:,\d{3})*(?:\.\d+)?|\d+\.\d+)/g;
                const matches = text.match(pricePattern);
                return matches || [];
            }
            
            // 新增：日期格式化辅助函数
            function formatDateKey(year, month, day) {
                return `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
            }
            
            function getDateKeyFromTimestamp(timestamp) {
                const date = new Date(timestamp);
                return formatDateKey(date.getFullYear(), date.getMonth() + 1, date.getDate());
            }
            
            // 新增：来源筛选
            let currentFilterSource = 'all';
            function filterBySource(source) {
                currentFilterSource = source;
                
                // 更新标签状态
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.filter-tab[data-filter="${source}"]`)?.classList.add('active');
                
                // 重新渲染日历以更新记录条数
                renderCalendar();
                
                renderRecords();
            }
            
            // 新增：视图切换
            let currentView = 'grid';
            function switchView(view) {
                currentView = view;
                localStorage.setItem('historyView', view);
                
                const container = document.getElementById('historyListContainer');
                container.className = `history-list ${view}-view`;
                
                // 更新按钮状态
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.view-btn[data-view="${view}"]`)?.classList.add('active');
            }
            
            // 新增：日历相关
            let currentCalendarYear = new Date().getFullYear();
            let currentCalendarMonth = new Date().getMonth() + 1;
            let selectedDate = null;
            
            function initCalendar() {
                console.log('initCalendar called');
                console.log('historyRecords length:', historyRecords.length);
                console.log('currentCalendarYear:', currentCalendarYear);
                console.log('currentCalendarMonth:', currentCalendarMonth);
                
                renderCalendar();
                loadSavedView();
                
                // 强制渲染历史记录
                console.log('Forcing renderRecords...');
                renderRecords();
            }
            
            function renderCalendar() {
                console.log('renderCalendar called');
                
                const firstDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 1);
                const lastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();
                
                console.log('Calendar data:', { firstDay, lastDay, daysInMonth, startDayOfWeek });
                
                const calendarDays = document.getElementById('calendarDays');
                const currentMonthEl = document.getElementById('calendarCurrentMonth');
                
                console.log('Calendar elements:', { calendarDays, currentMonthEl });
                
                if (!calendarDays || !currentMonthEl) {
                    console.error('Calendar elements not found!');
                    return;
                }
                
                currentMonthEl.textContent = `${currentCalendarYear} / ${currentCalendarMonth}`;
                
                calendarDays.innerHTML = '';
                
                // 获取当月记录统计
                const recordCounts = getRecordCountsByDate(currentCalendarYear, currentCalendarMonth);
                console.log('Record counts:', recordCounts);
                
                // 填充空白日期
                for (let i = 0; i < startDayOfWeek; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day';
                    calendarDays.appendChild(emptyDay);
                }
                
                // 填充日期格子
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const count = recordCounts[day] || 0;
                    const isSelected = selectedDate && 
                        selectedDate.year === currentCalendarYear && 
                        selectedDate.month === currentCalendarMonth && 
                        selectedDate.day === day;
                    
                    dayEl.className = `calendar-day ${count > 0 ? 'has-records' : ''} ${isSelected ? 'selected' : ''}`;
                    dayEl.innerHTML = `
                        <div class="calendar-day-number">${day}</div>
                        ${count > 0 ? `<div class="calendar-day-count">${count}条</div>` : ''}
                    `;
                    dayEl.onclick = () => selectDate(day);
                    
                    calendarDays.appendChild(dayEl);
                }
            }
            
            function getRecordCountsByDate(year, month) {
                const counts = {};
                historyRecords.forEach(record => {
                    const date = new Date(record.timestamp);
                    if (date.getFullYear() === year && date.getMonth() + 1 === month) {
                        // 根据当前筛选条件过滤
                        if (currentFilterSource === 'all' || 
                            (record.source || 'productManager') === currentFilterSource) {
                            const day = date.getDate();
                            counts[day] = (counts[day] || 0) + 1;
                        }
                    }
                });
                return counts;
            }
            
            function selectDate(day) {
                // 不设置 selectedDate，避免日期筛选
                
                // 隐藏日历，显示历史记录列表
                document.querySelector('.calendar-picker').style.display = 'none';
                document.getElementById('historyListContainer').style.display = 'grid';
                
                // 添加返回日历按钮
                addBackToCalendarButton();
                
                // 渲染所有记录（按来源筛选）
                renderRecords();
                
                // 滚动到指定日期
                const dateKey = formatDateKey(currentCalendarYear, currentCalendarMonth, day);
                const targetElement = document.getElementById(`date-${dateKey.replace(/\//g, '-')}`);
                
                console.log('Looking for date element:', `date-${dateKey.replace(/\//g, '-')}`);
                console.log('Target element found:', targetElement);
                
                if (targetElement) {
                    setTimeout(() => {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    console.log('Target element not found, available elements:', 
                        Array.from(document.querySelectorAll('[id^="date-"]')).map(el => el.id));
                }
            }
            
            function changeMonth(direction) {
                currentCalendarMonth += direction;
                
                if (currentCalendarMonth < 1) {
                    currentCalendarMonth = 12;
                    currentCalendarYear--;
                } else if (currentCalendarMonth > 12) {
                    currentCalendarMonth = 1;
                    currentCalendarYear++;
                }
                
                renderCalendar();
            }
            
            function showHistoryView() {
                // 切换到历史记录界面
                switchTab('historyViewer');
            }
            
            function addBackToCalendarButton() {
                // 检查是否已经存在返回按钮
                if (document.getElementById('backToCalendarBtn')) {
                    return;
                }
                // 仅在历史记录页显示
                if (typeof currentTab !== 'undefined' && currentTab !== 'historyViewer') {
                    return;
                }
                
                const backBtn = document.createElement('div');
                backBtn.id = 'backToCalendarBtn';
                backBtn.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 20px;
                    z-index: 1000;
                    background: #667eea;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 20px;
                    font-size: 14px;
                    cursor: pointer;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    display: flex;
                    align-items: center;
                    gap: 5px;
                `;
                backBtn.innerHTML = '← 返回日历';
                backBtn.onclick = backToCalendar;
                
                document.body.appendChild(backBtn);
            }
            
            function backToCalendar() {
                // 清除日期选择
                selectedDate = null;
                
                // 显示日历，隐藏列表
                document.querySelector('.calendar-picker').style.display = 'block';
                document.getElementById('historyListContainer').style.display = 'none';
                
                // 移除返回按钮
                const backBtn = document.getElementById('backToCalendarBtn');
                if (backBtn) {
                    backBtn.remove();
                }
                
                // 重新渲染日历
                renderCalendar();
            }
            
            function displayFilteredRecords(filtered) {
                const container = document.getElementById('historyListContainer');
                const emptyState = document.getElementById('historyEmptyState');
                
                container.innerHTML = '';
                
                // 如果没有传入filtered参数，使用renderRecords进行筛选
                if (!filtered) {
                    renderRecords();
                    return;
                }
                
                if (filtered.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                filtered.forEach(record => {
                    const card = document.createElement('div');
                    card.className = `history-card ${selectedRecords.includes(record.id) ? 'comparing' : ''}`;
                    
                    const sourceIcon = {
                        'productManager': '📦',
                        'priceAdjuster': '💰',
                        'symbolChanger': '🔄'
                    }[record.source || 'productManager'] || '📦';
                    
                    card.innerHTML = `
                        <img src="${record.thumbnail}" class="history-card-thumbnail" onclick="HistoryManager.showImage('${record.id}')">
                        <div class="history-card-title">${sourceIcon} ${record.title}</div>
                        <div class="history-card-date">${record.date}</div>
                        <div class="history-card-info">
                            <span>产品数: ${record.productCount}</span>
                        </div>
                        <div class="history-card-actions">
                            <button class="btn btn-secondary" onclick="HistoryManager.viewRecord('${record.id}')">查看</button>
                            <button class="btn btn-danger" onclick="HistoryManager.deleteRecord('${record.id}')">删除</button>
                        </div>
                    `;
                    
                    if (isCompareMode) {
                        card.onclick = () => toggleRecordSelection(record.id);
                    }
                    
                    container.appendChild(card);
                });
            }
            
            function loadSavedView() {
                const savedView = localStorage.getItem('historyView') || 'grid';
                switchView(savedView);
            }
            
            // HTML转义函数
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 更新 renderRecords 函数，支持筛选和视图
            const originalRenderRecords = typeof renderRecords !== 'undefined' ? renderRecords : null;
            renderRecords = function() {
                console.log('=== renderRecords START ===');
                console.log('currentFilterSource:', currentFilterSource);
                console.log('Total records:', historyRecords.length);
                
                let filtered = historyRecords;
                
                // 只根据来源筛选，不限制日期
                if (currentFilterSource !== 'all') {
                    const beforeFilter = filtered.length;
                    filtered = filtered.filter(r => (r.source || 'productManager') === currentFilterSource);
                    console.log('Filter applied:', currentFilterSource, 'before:', beforeFilter, 'after:', filtered.length);
                    if (filtered.length > 0) {
                        console.log('Sample filtered sources:', filtered.slice(0, 3).map(r => r.source || 'productManager'));
                    }
                } else {
                    console.log('No filter applied (showing all)');
                }
                
                console.log('Filtered records:', filtered.length);
                console.log('=== renderRecords END ===');
                
                const container = document.getElementById('historyListContainer');
                const emptyState = document.getElementById('historyEmptyState');
                
                if (!container) {
                    console.log('historyListContainer not found');
                    return;
                }
                
                if (filtered.length === 0) {
                    if (emptyState) emptyState.style.display = 'block';
                    container.innerHTML = '';
                    return;
                }
                
                if (emptyState) emptyState.style.display = 'none';
                container.innerHTML = '';
                
                // 按日期分组
                const groupedByDate = {};
                filtered.forEach(record => {
                    const dateKey = getDateKeyFromTimestamp(record.timestamp);
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(record);
                });
                
                // 按日期降序排列
                const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });
                
                // 渲染每个日期分组
                sortedDates.forEach(dateKey => {
                    // 添加日期标题
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-group-header';
                    dateHeader.id = `date-${dateKey.replace(/\//g, '-')}`;
                    dateHeader.innerHTML = `<h3>${dateKey}</h3>`;
                    container.appendChild(dateHeader);
                    
                    // 渲染该日期的记录
                    groupedByDate[dateKey].forEach(record => {
                        const card = document.createElement('div');
                        card.className = `history-card ${selectedRecords.includes(record.id) ? 'comparing' : ''}`;
                        
                        const sourceIcon = {
                            'productManager': '📦',
                            'priceAdjuster': '💰',
                            'symbolChanger': '🔄'
                        }[record.source || 'productManager'] || '📦';
                        
                        // 生成缩略图HTML：如果有预览文本则显示文本，否则显示占位图
                        let thumbnailHtml = '';
                        if (record.previewText && record.previewText.length > 0) {
                            thumbnailHtml = `<div class="history-card-thumbnail-text" onclick="HistoryManager.viewRecord('${record.id}')">
                                ${record.previewText.map(line => `<div class="preview-line">${escapeHtml(line || '')}</div>`).join('')}
                            </div>`;
                        } else {
                            thumbnailHtml = `<img src="${record.thumbnail}" class="history-card-thumbnail" onclick="HistoryManager.showImage('${record.id}')">`;
                        }
                        
                        card.innerHTML = `
                            ${thumbnailHtml}
                            <div class="history-card-title">${sourceIcon} ${record.title}</div>
                            <div class="history-card-date">${record.date}</div>
                            <div class="history-card-info">
                                <span>产品数: ${record.productCount}</span>
                            </div>
                            <div class="history-card-actions">
                                <button class="btn btn-secondary" onclick="HistoryManager.viewRecord('${record.id}')">查看</button>
                                <button class="btn btn-danger" onclick="HistoryManager.deleteRecord('${record.id}')">删除</button>
                            </div>
                        `;
                        
                        if (isCompareMode) {
                            card.onclick = () => toggleRecordSelection(record.id);
                        }
                        
                        container.appendChild(card);
                    });
                });
            };
            
            // 更新init函数
            const originalInit = init;
            init = function() {
                originalInit();
                
                // 延迟初始化日历，确保DOM已加载
                setTimeout(() => {
                    console.log('HistoryManager init - starting calendar initialization');
                    if (typeof initCalendar === 'function') {
                        initCalendar();
                    }
                }, 100);
            };
            
            return {
                init: init,
                saveRecord: saveRecord,
                deleteRecord: deleteRecord,
                viewRecord: viewRecord,
                showImage: showImage,
                showSaveDialog: showSaveDialog,
                enterCompareMode: enterCompareMode,
                exitCompareMode: exitCompareMode,
                toggleRecordSelection: toggleRecordSelection,
                startCompare: startCompare,
                filterRecords: filterRecords,
                clearFilter: clearFilter,
                deleteAll: deleteAll,
                renderRecords: renderRecords,
                filterBySource: filterBySource,
                switchView: switchView,
                changeMonth: changeMonth,
                selectDate: selectDate,
                showHistoryView: showHistoryView,
                displayFilteredRecords: displayFilteredRecords,
                addBackToCalendarButton: addBackToCalendarButton,
                backToCalendar: backToCalendar
            };
        })();
        
        // ========== 全局Tab切换逻辑 ==========
        let currentTab = 'productManager'; // 默认显示产品管理
        
        // 确保在页面加载时初始化currentTab
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof currentTab === 'undefined') {
                currentTab = 'productManager';
            }
        });
        
        function switchTab(tabName) {
            // 确保currentTab已初始化
            if (typeof currentTab === 'undefined') {
                currentTab = 'productManager';
            }
            
            console.log('Switching to tab:', tabName, 'currentTab:', currentTab);
            
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有nav-item的active状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 显示选中的tab内容
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 激活对应的nav-item
            const targetNavItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (targetNavItem) {
                targetNavItem.classList.add('active');
            }
            
            // 更新顶部标题
            const titles = {
                'productManager': '产品管理',
                'priceAdjuster': '价格调整',
                'symbolChanger': '符号更换',
                'historyViewer': '历史记录',
                'membership': '会员中心',
                'settings': '我的'
            };
            document.getElementById('topPageTitle').textContent = titles[tabName] || '家电报价助手';
            
            currentTab = tabName;
            
            // 如果切换到历史记录，强制刷新日历和记录
            if (tabName === 'historyViewer') {
                setTimeout(() => {
                    console.log('Switched to historyViewer, force refreshing...');
                    if (typeof HistoryManager !== 'undefined' && HistoryManager.renderRecords) {
                        HistoryManager.renderRecords();
                    }
                    // 若当前处于列表视图（日历隐藏、列表可见），则重建返回日历按钮
                    try {
                        const calendarEl = document.querySelector('.calendar-picker');
                        const listEl = document.getElementById('historyListContainer');
                        const calendarHidden = calendarEl && getComputedStyle(calendarEl).display === 'none';
                        const listVisible = listEl && getComputedStyle(listEl).display !== 'none';
                        if (calendarHidden && listVisible && HistoryManager && HistoryManager.addBackToCalendarButton) {
                            HistoryManager.addBackToCalendarButton();
                        }
                    } catch (e) { /* noop */ }
                }, 100);
            } else {
                // 离开历史页时移除返回日历按钮
                const backBtn = document.getElementById('backToCalendarBtn');
                if (backBtn) backBtn.remove();
            }
        }
        
        function openCurrentPageMenu() {
            alert('当前页面：' + document.getElementById('topPageTitle').textContent);
        }
        
        // ========== 初始化 ==========
        document.addEventListener('DOMContentLoaded', function() {
            ProductManager.init();
            PriceAdjuster.init();
            SymbolChanger.init();
            Membership.init();
            Settings.init();
            HistoryManager.init();
            switchTab('productManager'); // 初始化显示产品管理页面
        });
        
        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    console.log('Service Worker 注册成功:', registration);
                })
                .catch(function(error) {
                    console.log('Service Worker 注册失败:', error);
                });
        }
    </script>
</body>
</html>

